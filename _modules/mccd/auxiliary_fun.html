
<!DOCTYPE html>

<html lang="en">
<head>
<meta content="ie=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta charset="utf-8"/>
<title>
      mccd.auxiliary_fun | mccd v1.1.1
    </title>
<link href="../../_static/pygments.css" rel="stylesheet"/>
<link href="../../_static/theme.css" rel="stylesheet"/>
<link href="../../search.html" rel="search" title="Search"/>
<link href="../../genindex.html" rel="index" title="Index"/>
</head>
<body class="text-gray-900 antialiased min-h-screen md:h-screen flex flex-col">
<a class="block text-xl bg-white px-8 py-4 z-20 absolute top-0 left-0 transform -translate-x-full focus:translate-x-0 transition-transform duration-75" href="#mccd-auxiliary-fun" title="Skip navigation links">Skip to content</a>
<header class="md:sticky top-0 bg-gray-900 shadow-md flex md:flex-row justify-between items-center z-10"><a aria-label="Back to homepage" class="hover:bg-gray-700 focus:bg-gray-700 tooltipped tooltipped-se" href="../../index.html">
<h2 class="text-xl text-gray-100 mx-5 py-4">mccd v1.1.1</h2>
</a><form action="../../search.html" class="hidden md:flex my-auto mx-5 justify-between items-center print:hidden" id="searchbox" method="get">
<input aria-label="Search the docs" class="p-2 flex-1 focus:bg-yellow-200" id="search-input" name="q" placeholder="Search the docs" style="width: 300px;" type="search"/>
<button aria-label="Get search results" class="p-2 text-white bg-gray-700 hover:bg-gray-200 hover:text-pink-500 focus:bg-gray-200 focus:text-pink-500 tooltipped tooltipped-sw">
<svg aria-hidden="true" class="fill-current stroke-current h-6 w-6" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg>
</button>
</form>
</header>
<div class="md:overflow-hidden flex flex-col md:flex-row flex-1"><nav class="h-full fixed md:relative inset-y-0 left-0 z-20 md:z-0 bg-white text-gray-700 border-r overflow-x-hidden pt-16 print:hidden flex flex-col" data-menu="closed" role="navigation" style="width: 270px;">
<div class="nav-toc"><p class="caption">Getting Started</p>
<ul>
<li class="toctree-l1"><div class="nav-link"><a class="reference internal" href="../../about.html">About</a></div></li>
<li class="toctree-l1"><div class="nav-link"><a class="reference internal" href="../../installation.html">Installation</a></div></li>
<li class="toctree-l1"><div class="nav-link"><a class="reference internal" href="../../quickstart.html">Quickstart Tutorial</a></div></li>
<li class="toctree-l1"><div class="nav-link"><a class="reference internal" href="../../changelog.html">Changelog</a></div></li>
</ul>
<p class="caption">API Documentation</p>
<ul>
<li class="toctree-l1"><div class="nav-link"><svg aria-hidden="true" class="expand" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path></svg><a class="reference internal" href="../../mccd.html">mccd</a></div><ul>
<li class="toctree-l2"><div class="nav-link"><a class="reference internal" href="../../mccd.auxiliary_fun.html">mccd.auxiliary_fun</a></div></li>
<li class="toctree-l2"><div class="nav-link"><a class="reference internal" href="../../mccd.dataset_generation.html">mccd.dataset_generation</a></div></li>
<li class="toctree-l2"><div class="nav-link"><a class="reference internal" href="../../mccd.grads.html">mccd.grads</a></div></li>
<li class="toctree-l2"><div class="nav-link"><a class="reference internal" href="../../mccd.info.html">mccd.info</a></div></li>
<li class="toctree-l2"><div class="nav-link"><a class="reference internal" href="../../mccd.mccd.html">mccd.mccd</a></div></li>
<li class="toctree-l2"><div class="nav-link"><a class="reference internal" href="../../mccd.mccd_utils.html">mccd.mccd_utils</a></div></li>
<li class="toctree-l2"><div class="nav-link"><a class="reference internal" href="../../mccd.proxs.html">mccd.proxs</a></div></li>
<li class="toctree-l2"><div class="nav-link"><a class="reference internal" href="../../mccd.utils.html">mccd.utils</a></div></li>
</ul>
</li>
<li class="toctree-l1"><div class="nav-link"><a class="reference internal" href="../../z_ref.html">References</a></div></li>
</ul>
<p class="caption">Guidelines</p>
<ul>
<li class="toctree-l1"><div class="nav-link"><a class="reference internal" href="../../contributing.html">Contributing</a></div></li>
<li class="toctree-l1"><div class="nav-link"><a class="reference internal" href="../../citing.html">Citing this Package</a></div></li>
</ul>
</div>
<button aria-label="Close menu" class="text-4xl text-gray-800 p-4 bottom-0 hover:text-pink-500 md:hidden focus:text-pink-500 self-center" id="closeNavBtn" title="Close menu">
<svg aria-hidden="true" class="fill-current stroke-current h-6 w-6" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="overflow-y-auto md:w-full flex flex-col flex-1" id="main-wrapper">
<main class="px-5 md:ml-fluid flex-1" role="main">
<h1>Source code for mccd.auxiliary_fun</h1><pre>
<code><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sa">r</span><span class="sd">"""AUXILIARY FUNCTIONS.</span>

<span class="sd">Essential MCCD helper functions. They are needed to:</span>

<span class="sd">- Generate simulated datasets.</span>

<span class="sd">- Preprocess, fit and validate MCCD PSF models.</span>

<span class="sd">- Parse the configuration file.</span>

<span class="sd">- Run automatically the MCCD algortithm from the config file parameters.</span>

<span class="sd">:Authors:   Tobias Liaudat &lt;tobias.liaudat@cea.fr&gt;</span>

<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mccd</span>
<span class="kn">import</span> <span class="nn">mccd.mccd_utils</span> <span class="k">as</span> <span class="nn">mccd_utils</span>
<span class="kn">import</span> <span class="nn">mccd.utils</span> <span class="k">as</span> <span class="nn">utils</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">galsim</span> <span class="k">as</span> <span class="nn">gs</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">from</span> <span class="nn">configparser</span> <span class="kn">import</span> <span class="n">ConfigParser</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>


<div class="viewcode-block" id="GenerateSimDataset"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.GenerateSimDataset">[docs]</a><span class="k">class</span> <span class="nc">GenerateSimDataset</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">"""Generate simulated dataset for training and validating PSF models.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_pos_path: str</span>
<span class="sd">        Path to the global positions of the PSF that will be used for the</span>
<span class="sd">        training.</span>
<span class="sd">    input_ccd_path: str</span>
<span class="sd">        Path to the corresponding CCDs of the global positions.</span>
<span class="sd">    output_path: str</span>
<span class="sd">        Path to the folder to save the simulated datasets.</span>
<span class="sd">    e1_analytic_fun: function</span>
<span class="sd">        The analytic e1 ellipticity function that will define an ellipticity</span>
<span class="sd">        e1 for each position in the focal plane.</span>
<span class="sd">    e2_analytic_fun: function</span>
<span class="sd">        The analytic e2 ellipticity function that will define an ellipticity</span>
<span class="sd">        e2 for each position in the focal plane.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The simulated PSFs are based on the Moffat profile and we are using Galsim</span>
<span class="sd">    to generate them.</span>
<span class="sd">    We base ourselves on two analytic functions that have to output an</span>
<span class="sd">    ellipticity for each position in the focal plane.</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_pos_path</span><span class="p">,</span> <span class="n">input_ccd_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span>
                 <span class="n">e1_analytic_fun</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e2_analytic_fun</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Initialize the class."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_pos_path</span> <span class="o">=</span> <span class="n">input_pos_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_ccd_path</span> <span class="o">=</span> <span class="n">input_ccd_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="n">output_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e1_analytic_fun</span> <span class="o">=</span> <span class="n">e1_analytic_fun</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e2_analytic_fun</span> <span class="o">=</span> <span class="n">e2_analytic_fun</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccd_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Train/Test data params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_flux</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta_psf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pix_scale</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desired_SNR</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_grid_xy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_ccd</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">e1_analytic_fun</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e1_analytic_fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e1_catalog_fun</span>
        <span class="k">if</span> <span class="n">e2_analytic_fun</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e2_analytic_fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e2_catalog_fun</span>

<div class="viewcode-block" id="GenerateSimDataset.load_data"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.GenerateSimDataset.load_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Load data from input paths."""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_pos_path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ccd_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_ccd_path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'The positions or ccd path was not found. Check the paths.'</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span></div>

<div class="viewcode-block" id="GenerateSimDataset.generate_train_data"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.GenerateSimDataset.generate_train_data">[docs]</a>    <span class="k">def</span> <span class="nf">generate_train_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.6</span><span class="p">,</span> <span class="n">image_size</span><span class="o">=</span><span class="mi">51</span><span class="p">,</span> <span class="n">psf_flux</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                            <span class="n">beta_psf</span><span class="o">=</span><span class="mf">4.8</span><span class="p">,</span> <span class="n">pix_scale</span><span class="o">=</span><span class="mf">0.187</span><span class="p">,</span>
                            <span class="n">desired_SNR</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">catalog_id</span><span class="o">=</span><span class="mi">2086592</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Generate the training dataset and saves it in fits format.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sigma: float</span>
<span class="sd">            Size of the PSF in sigma's. (Sigma from Galsim's HSM adaptive</span>
<span class="sd">            moments).</span>
<span class="sd">            Default is ``1.6``.</span>
<span class="sd">        image_size: int</span>
<span class="sd">            Dimension of the squared image stamp. (image_size x image_size)</span>
<span class="sd">            Default is ``51``.</span>
<span class="sd">        psf_flux: float</span>
<span class="sd">            Total PSF photometric flux.</span>
<span class="sd">            Default is ``1``.</span>
<span class="sd">        beta_psf: float</span>
<span class="sd">            Moffat beta parameter.</span>
<span class="sd">            Default is ``4.8``.</span>
<span class="sd">        pix_scale: float</span>
<span class="sd">            Pixel scale.</span>
<span class="sd">            Default is ``0.187``.</span>
<span class="sd">        desired_SNR: float</span>
<span class="sd">            Desired SNR</span>
<span class="sd">            Default is ``30``.</span>
<span class="sd">        catalog_id: int</span>
<span class="sd">            Catalog identifier number.</span>
<span class="sd">            Default is ``2086592``.</span>

<span class="sd">        """</span>
        <span class="c1"># Parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span> <span class="o">=</span> <span class="n">image_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_flux</span> <span class="o">=</span> <span class="n">psf_flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta_psf</span> <span class="o">=</span> <span class="n">beta_psf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pix_scale</span> <span class="o">=</span> <span class="n">pix_scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desired_SNR</span> <span class="o">=</span> <span class="n">desired_SNR</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog_id</span> <span class="o">=</span> <span class="n">catalog_id</span>

        <span class="c1"># Define the ellipticities for each stars</span>
        <span class="n">e1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">e1_catalog_fun</span><span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">])</span>
        <span class="n">e2s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">e2_catalog_fun</span><span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">])</span>

        <span class="c1"># Define the constant shape of the stars (before the shearing)</span>
        <span class="n">fwhm_psf</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span> <span class="o">*</span> <span class="n">sigma</span>
        <span class="n">fwhms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">e1s</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">fwhm_psf</span>  <span class="c1"># Arround 5. and 6. in sigma</span>

        <span class="c1"># Generate the vignets</span>
        <span class="n">new_vignets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">e1s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">))</span>
        <span class="n">new_e1_HSM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">e1s</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">new_e2_HSM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">e1s</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">new_sig_HSM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">e1s</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">e1s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="c1"># PSF generation. Define size</span>
            <span class="n">psf</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">Moffat</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="n">fwhms</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">*</span> <span class="n">pix_scale</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta_psf</span><span class="p">)</span>

            <span class="c1"># Define the Flux</span>
            <span class="n">psf</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">withFlux</span><span class="p">(</span><span class="n">psf_flux</span><span class="p">)</span>
            <span class="c1"># Define the shear</span>
            <span class="n">psf</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">shear</span><span class="p">(</span><span class="n">g1</span><span class="o">=</span><span class="n">e1s</span><span class="p">[</span><span class="n">it</span><span class="p">],</span> <span class="n">g2</span><span class="o">=</span><span class="n">e2s</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
            <span class="c1"># Draw the PSF on a vignet</span>
            <span class="n">noisy_image_epsf</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">ImageF</span><span class="p">(</span><span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">)</span>
            <span class="c1"># Define intrapixel shift (uniform distribution in [-0.5,0.5])</span>
            <span class="n">rand_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
            <span class="n">psf</span><span class="o">.</span><span class="n">drawImage</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">noisy_image_epsf</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">rand_shift</span><span class="p">,</span>
                          <span class="n">scale</span><span class="o">=</span><span class="n">pix_scale</span><span class="p">)</span>

            <span class="n">sigma_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">noisy_image_epsf</span><span class="o">.</span><span class="n">array</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="n">desired_SNR</span> <span class="o">*</span> <span class="n">image_size</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
            <span class="c1"># Generate Gaussian noise for the PSF</span>
            <span class="n">gaussian_noise</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">GaussianNoise</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma_noise</span><span class="p">)</span>

            <span class="c1"># Before adding the noise, we measure the ellipticity components</span>
            <span class="n">my_moments</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">hsm</span><span class="o">.</span><span class="n">FindAdaptiveMom</span><span class="p">(</span><span class="n">noisy_image_epsf</span><span class="p">)</span>
            <span class="n">new_e1_HSM</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_moments</span><span class="o">.</span><span class="n">observed_shape</span><span class="o">.</span><span class="n">g1</span>
            <span class="n">new_e2_HSM</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_moments</span><span class="o">.</span><span class="n">observed_shape</span><span class="o">.</span><span class="n">g2</span>
            <span class="n">new_sig_HSM</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_moments</span><span class="o">.</span><span class="n">moments_sigma</span>

            <span class="c1"># Add Gaussian noise to the PSF</span>
            <span class="n">noisy_image_epsf</span><span class="o">.</span><span class="n">addNoise</span><span class="p">(</span><span class="n">gaussian_noise</span><span class="p">)</span>

            <span class="n">new_vignets</span><span class="p">[</span><span class="n">it</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">noisy_image_epsf</span><span class="o">.</span><span class="n">array</span>

        <span class="n">new_masks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_SExtractor_mask</span><span class="p">(</span><span class="n">new_vignets</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=-</span><span class="mf">1e5</span><span class="p">)</span>

        <span class="c1"># Build the dictionary</span>
        <span class="n">train_dic</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'VIGNET_LIST'</span><span class="p">:</span> <span class="n">new_vignets</span><span class="p">,</span>
                     <span class="s1">'GLOB_POSITION_IMG_LIST'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span>
                     <span class="s1">'MASK_LIST'</span><span class="p">:</span> <span class="n">new_masks</span><span class="p">,</span> <span class="s1">'CCD_ID_LIST'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccd_id</span><span class="p">,</span>
                     <span class="s1">'TRUE_E1_HSM'</span><span class="p">:</span> <span class="n">new_e1_HSM</span><span class="p">,</span> <span class="s1">'TRUE_E2_HSM'</span><span class="p">:</span> <span class="n">new_e2_HSM</span><span class="p">,</span>
                     <span class="s1">'TRUE_SIG_HSM'</span><span class="p">:</span> <span class="n">new_sig_HSM</span><span class="p">}</span>

        <span class="c1"># Save the fits file</span>
        <span class="n">mccd_utils</span><span class="o">.</span><span class="n">save_fits</span><span class="p">(</span><span class="n">train_dic</span><span class="p">,</span> <span class="n">train_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cat_id</span><span class="o">=</span><span class="n">catalog_id</span><span class="p">,</span>
                             <span class="n">output_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="GenerateSimDataset.generate_test_data"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.GenerateSimDataset.generate_test_data">[docs]</a>    <span class="k">def</span> <span class="nf">generate_test_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_grid</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">y_grid</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_ccd</span><span class="o">=</span><span class="mi">40</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Generate the test dataset and save it into a fits file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_grid: int</span>
<span class="sd">            Horizontal number of elements of the testing grid in one CCD.</span>
<span class="sd">        y_grid: int</span>
<span class="sd">            Vertical number of elements of the testing grid in one CCD.</span>
<span class="sd">        n_ccd: int</span>
<span class="sd">            Number of CCDs in the instrument.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        ``n_ccd`` should be coherent with the corresponding functions on</span>
<span class="sd">        ``mccd.mccd_utils`` that do the change of coordiante system.</span>

<span class="sd">        """</span>
        <span class="c1"># Parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_grid_xy</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_grid</span><span class="p">,</span>
                             <span class="n">y_grid</span><span class="p">]</span>  <span class="c1"># Grid size for the PSF generation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_ccd</span> <span class="o">=</span> <span class="n">n_ccd</span>

        <span class="c1"># Generation of the test positions</span>
        <span class="n">ccd_unique_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_ccd</span><span class="p">)</span>

        <span class="c1"># Saving file dictionary</span>
        <span class="n">loc2glob</span> <span class="o">=</span> <span class="n">mccd_utils</span><span class="o">.</span><span class="n">Loc2Glob</span><span class="p">()</span>

        <span class="c1"># Generate local generic grid</span>
        <span class="n">x_lin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">,</span>
                            <span class="n">stop</span><span class="o">=</span><span class="n">loc2glob</span><span class="o">.</span><span class="n">x_npix</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">,</span>
                            <span class="n">num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_grid_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">y_lin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">,</span>
                            <span class="n">stop</span><span class="o">=</span><span class="n">loc2glob</span><span class="o">.</span><span class="n">y_npix</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">,</span>
                            <span class="n">num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_grid_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">xv</span><span class="p">,</span> <span class="n">yv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_lin</span><span class="p">,</span> <span class="n">y_lin</span><span class="p">)</span>
        <span class="n">x_coor</span> <span class="o">=</span> <span class="n">xv</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">y_coor</span> <span class="o">=</span> <span class="n">yv</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="n">position_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ccd_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ccd_unique_list</span><span class="p">)):</span>
            <span class="n">x_glob</span><span class="p">,</span> <span class="n">y_glob</span> <span class="o">=</span> <span class="n">loc2glob</span><span class="o">.</span><span class="n">loc2glob_img_coord</span><span class="p">(</span>
                <span class="n">ccd_n</span><span class="o">=</span><span class="n">ccd_unique_list</span><span class="p">[</span><span class="n">it</span><span class="p">],</span>
                <span class="n">x_coor</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x_coor</span><span class="p">),</span> <span class="n">y_coor</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">y_coor</span><span class="p">))</span>
            <span class="n">position_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_glob</span><span class="p">,</span> <span class="n">y_glob</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">ccd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_glob</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">ccd_unique_list</span><span class="p">[</span><span class="n">it</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                    <span class="nb">int</span><span class="p">))</span>

        <span class="c1"># Obtain final positions and ccd_id list</span>
        <span class="n">test_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">position_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">test_ccd_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ccd_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Calculate the ellipticities on the testing positions</span>
        <span class="n">test_e1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">e1_catalog_fun</span><span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span>
             <span class="n">test_positions</span><span class="p">])</span>
        <span class="n">test_e2s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">e2_catalog_fun</span><span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span>
             <span class="n">test_positions</span><span class="p">])</span>

        <span class="n">fwhm_psf</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span>
        <span class="n">test_fwhms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
            <span class="n">test_e1s</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">fwhm_psf</span>  <span class="c1"># Arround 5. and 6. in sigma</span>

        <span class="c1"># Generate the vignets</span>
        <span class="n">test_vignets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="n">test_e1s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">))</span>
        <span class="n">test_e1_HSM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">test_e1s</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">test_e2_HSM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">test_e1s</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">test_sig_HSM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">test_e1s</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">test_e1s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="c1"># PSF generation. Define size</span>
            <span class="n">psf</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">Moffat</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="n">test_fwhms</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix_scale</span><span class="p">,</span>
                            <span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta_psf</span><span class="p">)</span>
            <span class="c1"># Define the Flux</span>
            <span class="n">psf</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">withFlux</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psf_flux</span><span class="p">)</span>
            <span class="c1"># Define the shear</span>
            <span class="n">psf</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">shear</span><span class="p">(</span><span class="n">g1</span><span class="o">=</span><span class="n">test_e1s</span><span class="p">[</span><span class="n">it</span><span class="p">],</span> <span class="n">g2</span><span class="o">=</span><span class="n">test_e2s</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
            <span class="c1"># Draw the PSF on a vignet</span>
            <span class="n">image_epsf</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">ImageF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">)</span>
            <span class="n">psf</span><span class="o">.</span><span class="n">drawImage</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image_epsf</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pix_scale</span><span class="p">)</span>

            <span class="c1"># Before adding the noise, we measure the ellipticity components</span>
            <span class="n">my_moments</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">hsm</span><span class="o">.</span><span class="n">FindAdaptiveMom</span><span class="p">(</span><span class="n">image_epsf</span><span class="p">)</span>
            <span class="n">test_e1_HSM</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_moments</span><span class="o">.</span><span class="n">observed_shape</span><span class="o">.</span><span class="n">g1</span>
            <span class="n">test_e2_HSM</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_moments</span><span class="o">.</span><span class="n">observed_shape</span><span class="o">.</span><span class="n">g2</span>
            <span class="n">test_sig_HSM</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_moments</span><span class="o">.</span><span class="n">moments_sigma</span>

            <span class="n">test_vignets</span><span class="p">[</span><span class="n">it</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">image_epsf</span><span class="o">.</span><span class="n">array</span>

        <span class="c1"># Build the masks</span>
        <span class="n">test_masks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_SExtractor_mask</span><span class="p">(</span><span class="n">test_vignets</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=-</span><span class="mf">1e5</span><span class="p">)</span>

        <span class="c1"># Build the dictionary</span>
        <span class="n">test_dic</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'VIGNET_LIST'</span><span class="p">:</span> <span class="n">test_vignets</span><span class="p">,</span>
                    <span class="s1">'GLOB_POSITION_IMG_LIST'</span><span class="p">:</span> <span class="n">test_positions</span><span class="p">,</span>
                    <span class="s1">'MASK_LIST'</span><span class="p">:</span> <span class="n">test_masks</span><span class="p">,</span> <span class="s1">'CCD_ID_LIST'</span><span class="p">:</span> <span class="n">test_ccd_id</span><span class="p">,</span>
                    <span class="s1">'TRUE_E1_HSM'</span><span class="p">:</span> <span class="n">test_e1_HSM</span><span class="p">,</span> <span class="s1">'TRUE_E2_HSM'</span><span class="p">:</span> <span class="n">test_e2_HSM</span><span class="p">,</span>
                    <span class="s1">'TRUE_SIG_HSM'</span><span class="p">:</span> <span class="n">test_sig_HSM</span><span class="p">}</span>

        <span class="c1"># Save the fits file</span>
        <span class="n">mccd_utils</span><span class="o">.</span><span class="n">save_fits</span><span class="p">(</span><span class="n">test_dic</span><span class="p">,</span> <span class="n">train_bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">cat_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog_id</span><span class="p">,</span>
                             <span class="n">output_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="GenerateSimDataset.e1_catalog_fun"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.GenerateSimDataset.e1_catalog_fun">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">e1_catalog_fun</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Define an e1 ellipticity per position.</span>

<span class="sd">        Analytic function for defining the e1 ellipticity as a function</span>
<span class="sd">        of the global position (MegaCam).</span>
<span class="sd">        """</span>
        <span class="c1"># Set the max and min values for the sinc coordinates</span>
        <span class="n">coor_min</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span>
        <span class="n">coor_max</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="c1"># Model dependent paremeters</span>
        <span class="n">scale_factor</span> <span class="o">=</span> <span class="mf">0.20001648</span>
        <span class="c1"># exp_decay_alpha = 702.86105548</span>
        <span class="n">exp_decay_alpha</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">scaled_x</span><span class="p">,</span> <span class="n">scaled_y</span> <span class="o">=</span> <span class="n">GenerateSimDataset</span><span class="o">.</span><span class="n">scale_coordinates</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">coor_min</span><span class="p">,</span> <span class="n">coor_max</span><span class="p">)</span>
        <span class="n">scaled_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">scaled_x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">scaled_y</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">vals_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">(</span><span class="n">scaled_d</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">exp_decay_alpha</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exp_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="o">-</span><span class="p">(</span><span class="n">scaled_d</span> <span class="o">-</span> <span class="p">((</span><span class="n">coor_max</span> <span class="o">+</span> <span class="n">coor_min</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">exp_decay_alpha</span><span class="p">)</span>
            <span class="n">scale_factor</span> <span class="o">*=</span> <span class="n">exp_weight</span>

        <span class="k">return</span> <span class="n">vals_x</span> <span class="o">*</span> <span class="n">scale_factor</span></div>

<div class="viewcode-block" id="GenerateSimDataset.e2_catalog_fun"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.GenerateSimDataset.e2_catalog_fun">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">e2_catalog_fun</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Define an e2 ellipticity per position.</span>

<span class="sd">        Analytic function for defining the e2 ellipticity as a function</span>
<span class="sd">        of the global position (MegaCam).</span>
<span class="sd">        """</span>
        <span class="c1"># Set the max and min values for the bessel coordinates</span>
        <span class="n">coor_min</span> <span class="o">=</span> <span class="o">-</span><span class="mi">15</span>
        <span class="n">coor_max</span> <span class="o">=</span> <span class="mi">15</span>

        <span class="c1"># Model dependent paremeters</span>
        <span class="n">max_order</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">scale_factor</span> <span class="o">=</span> <span class="mf">0.15001691</span>
        <span class="n">exp_decay_alpha</span> <span class="o">=</span> <span class="mf">201.13767350</span>

        <span class="k">return</span> <span class="n">GenerateSimDataset</span><span class="o">.</span><span class="n">bessel_generator</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">coor_min</span><span class="p">,</span> <span class="n">coor_max</span><span class="p">,</span> <span class="n">max_order</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span>
            <span class="n">circular_symetry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exp_decay_alpha</span><span class="o">=</span><span class="n">exp_decay_alpha</span><span class="p">)</span></div>

<div class="viewcode-block" id="GenerateSimDataset.scale_coordinates"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.GenerateSimDataset.scale_coordinates">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">scale_coordinates</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">coor_min</span><span class="p">,</span> <span class="n">coor_max</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Scale global coordinates."""</span>
        <span class="c1"># Set the max and min values for the coordinate system</span>
        <span class="n">loc2glob</span> <span class="o">=</span> <span class="n">mccd_utils</span><span class="o">.</span><span class="n">Loc2Glob</span><span class="p">()</span>
        <span class="n">grid_xmin</span> <span class="o">=</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">loc2glob</span><span class="o">.</span><span class="n">x_npix</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">loc2glob</span><span class="o">.</span><span class="n">x_gap</span>
        <span class="n">grid_xmax</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">loc2glob</span><span class="o">.</span><span class="n">x_npix</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">loc2glob</span><span class="o">.</span><span class="n">x_gap</span>
        <span class="n">grid_ymin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">loc2glob</span><span class="o">.</span><span class="n">y_npix</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">loc2glob</span><span class="o">.</span><span class="n">y_gap</span>
        <span class="n">grid_ymax</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">loc2glob</span><span class="o">.</span><span class="n">y_npix</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">loc2glob</span><span class="o">.</span><span class="n">y_gap</span>

        <span class="c1"># Scale the input coordinates</span>
        <span class="n">scaled_x</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">grid_xmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">grid_xmax</span> <span class="o">-</span> <span class="n">grid_xmin</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">coor_max</span> <span class="o">-</span> <span class="n">coor_min</span><span class="p">)</span> <span class="o">+</span> <span class="n">coor_min</span>
        <span class="n">scaled_y</span> <span class="o">=</span> <span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">grid_ymin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">grid_ymax</span> <span class="o">-</span> <span class="n">grid_ymin</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">coor_max</span> <span class="o">-</span> <span class="n">coor_min</span><span class="p">)</span> <span class="o">+</span> <span class="n">coor_min</span>

        <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scaled_x</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">scaled_y</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">scaled_x</span><span class="p">,</span> <span class="n">scaled_y</span></div>

<div class="viewcode-block" id="GenerateSimDataset.bessel_generator"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.GenerateSimDataset.bessel_generator">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">bessel_generator</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">coor_min</span><span class="p">,</span> <span class="n">coor_max</span><span class="p">,</span> <span class="n">max_order</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">,</span>
                         <span class="n">circular_symetry</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">exp_decay_alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Generate a type of Bessel function response."""</span>
        <span class="c1"># Scale coordinates</span>
        <span class="n">scaled_x</span><span class="p">,</span> <span class="n">scaled_y</span> <span class="o">=</span> <span class="n">GenerateSimDataset</span><span class="o">.</span><span class="n">scale_coordinates</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">coor_min</span><span class="p">,</span> <span class="n">coor_max</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">)</span>

        <span class="c1"># Calculate the function</span>
        <span class="n">vals_x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">vals_y</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">circular_symetry</span><span class="p">:</span>
            <span class="c1"># Sum of several orders</span>
            <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_order</span><span class="p">):</span>
                <span class="n">vals_x</span> <span class="o">+=</span> <span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">scaled_x</span><span class="p">)</span>
                <span class="n">vals_y</span> <span class="o">+=</span> <span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">scaled_y</span><span class="p">)</span>

            <span class="c1"># Generate the value and scale it</span>
            <span class="k">return</span> <span class="n">vals_x</span> <span class="o">*</span> <span class="n">vals_y</span> <span class="o">*</span> <span class="n">scale_factor</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">scaled_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">scaled_x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">scaled_y</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_order</span><span class="p">):</span>
                <span class="n">vals_x</span> <span class="o">+=</span> <span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">scaled_d</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">exp_decay_alpha</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">exp_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">scaled_d</span> <span class="o">-</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">coor_max</span> <span class="o">+</span> <span class="n">coor_min</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">exp_decay_alpha</span><span class="p">)</span>
                <span class="n">scale_factor</span> <span class="o">*=</span> <span class="n">exp_weight</span>

            <span class="k">return</span> <span class="n">vals_x</span> <span class="o">*</span> <span class="n">scale_factor</span></div>

<div class="viewcode-block" id="GenerateSimDataset.handle_SExtractor_mask"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.GenerateSimDataset.handle_SExtractor_mask">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">handle_SExtractor_mask</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">thresh</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Handle SExtractor masks.</span>

<span class="sd">        Reads SExtracted star stamps, generates MCCD-compatible masks</span>
<span class="sd">        (that is, binary weights), and replaces bad pixels with 0s - they will</span>
<span class="sd">        not be used by MCCD, but the ridiculous numerical values can</span>
<span class="sd">        otherwise still lead to problems because of convolutions.</span>
<span class="sd">        """</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">stars</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">stars</span> <span class="o">&lt;</span> <span class="n">thresh</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">stars</span><span class="p">[</span><span class="n">stars</span> <span class="o">&lt;</span> <span class="n">thresh</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">mask</span></div></div>


<div class="viewcode-block" id="mccd_fit"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.mccd_fit">[docs]</a><span class="k">def</span> <span class="nf">mccd_fit</span><span class="p">(</span><span class="n">starcat</span><span class="p">,</span> <span class="n">mccd_inst_kw</span><span class="p">,</span> <span class="n">mccd_fit_kw</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s1">'./'</span><span class="p">,</span>
             <span class="n">catalog_id</span><span class="o">=</span><span class="mi">1234567</span><span class="p">,</span> <span class="n">sex_thresh</span><span class="o">=-</span><span class="mf">1e5</span><span class="p">,</span> <span class="n">use_SNR_weight</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">saving_name</span><span class="o">=</span><span class="s1">'fitted_model'</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">"""Fits (train) the MCCD model.</span>

<span class="sd">    Then saves it.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    starcat: fits table</span>
<span class="sd">        Opened fits file containing a fits table,</span>
<span class="sd">        ie ``astropy.io.fits(path)[1]``.</span>
<span class="sd">        Should contain the training dataset with the columns:</span>
<span class="sd">        Mandatory: ``CCD_ID_LIST``, ``VIGNET_LIST``,</span>
<span class="sd">        ``GLOB_POSITION_IMG_LIST``, ``MASK_LIST``.</span>
<span class="sd">        Optional: ``SNR_WIN_LIST``.</span>
<span class="sd">    mccd_inst_kw: dict</span>
<span class="sd">        Parameters for the MCCD class initialization.</span>
<span class="sd">    mccd_fit_kw: dict</span>
<span class="sd">        Parameters for the MCCD class fit() function.</span>
<span class="sd">    output_dir: str</span>
<span class="sd">        Path to the directory to save the fitted model.</span>
<span class="sd">    catalog_id: int</span>
<span class="sd">        Id of the catalog being trained.</span>
<span class="sd">        Default is ``1234567``.</span>
<span class="sd">    sex_thresh: float</span>
<span class="sd">        Masking threshold, specially for SExtractor catalogs.</span>
<span class="sd">        Default is ``-1e5``.</span>
<span class="sd">    use_SNR_weight: bool</span>
<span class="sd">        Boolean to decide to use the SNR weight strategy. The columns</span>
<span class="sd">        ``SNR_WIN_LIST`` should be available on the input fits table.</span>
<span class="sd">    verbose: bool</span>
<span class="sd">        Verbose mode.</span>
<span class="sd">        Default is ``False``.</span>
<span class="sd">    saving_name: str</span>
<span class="sd">        Name of the fitted model file. Default is ``fitted_model``.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Saves the fitted model intro a ``.npy`` element on ``output_dir``.</span>

<span class="sd">    """</span>
    <span class="c1"># Extract the catalog and build the list with each ccd data</span>
    <span class="c1"># Stars are already masked and masks are provided</span>
    <span class="n">ccds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">starcat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'CCD_ID_LIST'</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">ccds_unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">starcat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'CCD_ID_LIST'</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">starcat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'GLOB_POSITION_IMG_LIST'</span><span class="p">])</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">starcat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'VIGNET_LIST'</span><span class="p">])</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">starcat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'MASK_LIST'</span><span class="p">])</span>

    <span class="c1"># If masks are not provided they have to be calculated</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">handle_SExtractor_mask</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">sex_thresh</span><span class="p">)</span>

    <span class="c1"># SNR weight calculation</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">use_SNR_weight</span><span class="p">:</span>
            <span class="n">SNRs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">starcat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'SNR_WIN_LIST'</span><span class="p">])</span>
            <span class="c1"># SNR strategy N6</span>
            <span class="n">max_snr_w</span> <span class="o">=</span> <span class="mf">2.0</span>
            <span class="n">min_snr_w</span> <span class="o">=</span> <span class="mf">0.25</span>
            <span class="n">SNR_weights</span> <span class="o">=</span> <span class="n">SNRs</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">SNRs</span><span class="p">)</span> <span class="o">+</span> <span class="n">SNRs</span><span class="p">)</span>
            <span class="n">SNR_weights</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">SNR_weights</span><span class="p">)</span>
            <span class="n">SNR_weights</span> <span class="o">*=</span> <span class="n">max_snr_w</span>
            <span class="n">SNR_weights</span><span class="p">[</span><span class="n">SNR_weights</span> <span class="o">&lt;</span> <span class="n">min_snr_w</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_snr_w</span>

            <span class="n">SNR_weight_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">SNR_weights</span><span class="p">[</span><span class="n">ccds</span> <span class="o">==</span> <span class="n">ccd</span><span class="p">]</span> <span class="k">for</span> <span class="n">ccd</span> <span class="ow">in</span>
                               <span class="n">ccds_unique</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If no SNR should be use we go to the no-SNR case</span>
            <span class="c1"># with the exception</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">SNR_weight_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'No SNR weights are being used.'</span><span class="p">)</span>

    <span class="n">pos_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">positions</span><span class="p">[</span><span class="n">ccds</span> <span class="o">==</span> <span class="n">ccd</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">ccd</span> <span class="ow">in</span> <span class="n">ccds_unique</span><span class="p">]</span>
    <span class="n">star_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">rca_format</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="n">ccds</span> <span class="o">==</span> <span class="n">ccd</span><span class="p">])</span>
                 <span class="k">for</span> <span class="n">ccd</span> <span class="ow">in</span> <span class="n">ccds_unique</span><span class="p">]</span>
    <span class="n">mask_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">rca_format</span><span class="p">(</span><span class="n">masks</span><span class="p">[</span><span class="n">ccds</span> <span class="o">==</span> <span class="n">ccd</span><span class="p">])</span>
                 <span class="k">for</span> <span class="n">ccd</span> <span class="ow">in</span> <span class="n">ccds_unique</span><span class="p">]</span>
    <span class="n">ccd_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ccds</span><span class="p">[</span><span class="n">ccds</span> <span class="o">==</span> <span class="n">ccd</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ccd</span> <span class="ow">in</span> <span class="n">ccds_unique</span><span class="p">]</span>
    <span class="n">ccd_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">_list</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_list</span> <span class="ow">in</span> <span class="n">ccd_list</span><span class="p">]</span>

    <span class="c1"># Instantiate the method</span>
    <span class="n">mccd_instance</span> <span class="o">=</span> <span class="n">mccd</span><span class="o">.</span><span class="n">MCCD</span><span class="p">(</span><span class="o">**</span><span class="n">mccd_inst_kw</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="c1"># Launch the training</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mccd_instance</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">star_list</span><span class="p">,</span> <span class="n">pos_list</span><span class="p">,</span> <span class="n">ccd_list</span><span class="p">,</span> <span class="n">mask_list</span><span class="p">,</span>
        <span class="n">SNR_weight_list</span><span class="p">,</span> <span class="o">**</span><span class="n">mccd_fit_kw</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">catalog_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">cat_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">catalog_id</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">catalog_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">cat_id</span> <span class="o">=</span> <span class="n">catalog_id</span>

    <span class="n">fitted_model_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">+</span> <span class="n">saving_name</span> <span class="o">+</span> <span class="n">cat_id</span>
    <span class="n">mccd_instance</span><span class="o">.</span><span class="n">quicksave</span><span class="p">(</span><span class="n">fitted_model_path</span><span class="p">)</span>

    <span class="c1"># Memory management (for clusters)</span>
    <span class="k">del</span> <span class="n">mccd_instance</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div>


<div class="viewcode-block" id="mccd_validation"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.mccd_validation">[docs]</a><span class="k">def</span> <span class="nf">mccd_validation</span><span class="p">(</span><span class="n">mccd_model_path</span><span class="p">,</span> <span class="n">testcat</span><span class="p">,</span> <span class="n">apply_degradation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">mccd_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">global_pol_interp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">sex_thresh</span><span class="o">=-</span><span class="mf">1e5</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">"""Validate a MCCD model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mccd_model_path: str</span>
<span class="sd">        Path to the saved trained MCCD model.</span>
<span class="sd">    testcat: fits table</span>
<span class="sd">        Opened fits file containing a fits table,</span>
<span class="sd">        ie ``astropy.io.fits(path)[1]``.</span>
<span class="sd">        Should contain the testing dataset with the columns:</span>
<span class="sd">        Mandatory: ``CCD_ID_LIST``, ``VIGNET_LIST``,</span>
<span class="sd">        ``GLOB_POSITION_IMG_LIST``, ``MASK_LIST``.</span>
<span class="sd">        Optional: ``RA_LIST``, ``DEC_LIST``.</span>
<span class="sd">    apply_degradation: bool</span>
<span class="sd">        Boolean determining if the returned PSFs should be matched to the</span>
<span class="sd">        observed stars by the application of a degradation which consists of</span>
<span class="sd">        an intra-pixel shift, fulx matching, etc.</span>
<span class="sd">        Default is ``True``.</span>
<span class="sd">    mccd_debug: bool</span>
<span class="sd">        Boolean to determine if the validation will be run in debug mode.</span>
<span class="sd">        Default is ``False``.</span>
<span class="sd">    global_pol_interp: bool</span>
<span class="sd">        Boolean to determine if the global model interpolation is done with</span>
<span class="sd">        a new position matrix (True) or if it is done with the RBF kernel</span>
<span class="sd">        interpolation (False).</span>
<span class="sd">        Default is ``False``.</span>
<span class="sd">    sex_thresh: float</span>
<span class="sd">        Masking threshold, specially for SExtractor catalogs.</span>
<span class="sd">        Default is ``-1e5``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    star_dict: dict</span>
<span class="sd">        Dictionary containing the data needed for validation purposes.</span>
<span class="sd">        Keys: ``PSF_VIGNET_LIST``, ``PSF_MOM_LIST``, ``STAR_MOM_LIST``,</span>
<span class="sd">        ``GLOB_POSITION_IMG_LIST``, ``VIGNET_LIST``,</span>
<span class="sd">        ``MASK_LIST``, ``CCD_ID_LIST``.</span>
<span class="sd">        Optional keys: ``RA_LIST``, ``DEC_LIST``,</span>
<span class="sd">        ``PSF_GLOB_VIGNET_LIST``, ``PSF_LOC_VIGNET_LIST``.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The parameter ``apply_degradation`` needs to be set to True if a pixel</span>
<span class="sd">    validation of the model is going to be done.</span>
<span class="sd">    """</span>
    <span class="c1"># Import</span>
    <span class="n">mccd_model</span> <span class="o">=</span> <span class="n">mccd</span><span class="o">.</span><span class="n">mccd_quickload</span><span class="p">(</span><span class="n">mccd_model_path</span><span class="p">)</span>

    <span class="c1"># Saving dictionary file</span>
    <span class="n">star_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Extract data</span>
    <span class="n">ccds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">testcat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'CCD_ID_LIST'</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">ccds_unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">testcat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'CCD_ID_LIST'</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">testcat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'GLOB_POSITION_IMG_LIST'</span><span class="p">])</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">testcat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'VIGNET_LIST'</span><span class="p">])</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">testcat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'MASK_LIST'</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">RA_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">testcat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'RA_LIST'</span><span class="p">])</span>
        <span class="n">DEC_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">testcat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'DEC_LIST'</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">RA_pos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">DEC_pos</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># If masks are not provided they have to be calculated</span>
    <span class="c1"># Mask convention: 1=good pixel / 0=bad pixel</span>
    <span class="k">if</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">handle_SExtractor_mask</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">sex_thresh</span><span class="p">)</span>

    <span class="c1"># Prepare data in ccd-list format</span>
    <span class="k">if</span> <span class="n">RA_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">val_RA_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">RA_pos</span><span class="p">[</span><span class="n">ccds</span> <span class="o">==</span> <span class="n">ccd</span><span class="p">]</span>
                       <span class="k">for</span> <span class="n">ccd</span> <span class="ow">in</span> <span class="n">ccds_unique</span><span class="p">]</span>
        <span class="n">val_DEC_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">DEC_pos</span><span class="p">[</span><span class="n">ccds</span> <span class="o">==</span> <span class="n">ccd</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">ccd</span> <span class="ow">in</span> <span class="n">ccds_unique</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">val_RA_list</span><span class="p">,</span> <span class="n">val_DEC_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">val_pos_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">positions</span><span class="p">[</span><span class="n">ccds</span> <span class="o">==</span> <span class="n">ccd</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">ccd</span> <span class="ow">in</span> <span class="n">ccds_unique</span><span class="p">]</span>
    <span class="n">val_star_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">rca_format</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="n">ccds</span> <span class="o">==</span> <span class="n">ccd</span><span class="p">])</span>
                     <span class="k">for</span> <span class="n">ccd</span> <span class="ow">in</span> <span class="n">ccds_unique</span><span class="p">]</span>
    <span class="n">val_mask_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">rca_format</span><span class="p">(</span><span class="n">masks</span><span class="p">[</span><span class="n">ccds</span> <span class="o">==</span> <span class="n">ccd</span><span class="p">])</span>
                     <span class="k">for</span> <span class="n">ccd</span> <span class="ow">in</span> <span class="n">ccds_unique</span><span class="p">]</span>
    <span class="n">val_ccd_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ccds</span><span class="p">[</span><span class="n">ccds</span> <span class="o">==</span> <span class="n">ccd</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ccd</span> <span class="ow">in</span> <span class="n">ccds_unique</span><span class="p">]</span>
    <span class="n">val_ccd_list_to_save</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">val_ccd_list</span><span class="p">)</span>
    <span class="n">val_ccd_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">_list</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">_list</span> <span class="ow">in</span> <span class="n">val_ccd_list</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">apply_degradation</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mccd_debug</span><span class="p">:</span>
            <span class="n">PSF_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">PSF_glob_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">PSF_loc_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">global_pol_interp</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">'''The polynomial interpolation for the global model is</span>
<span class="s1">                not available in mccd_debug mode.'''</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val_star_list</span><span class="p">)):</span>

                <span class="n">deg_PSFs</span><span class="p">,</span> <span class="n">deg_PSFs_glob</span><span class="p">,</span> <span class="n">deg_PSFs_loc</span> <span class="o">=</span> \
                    <span class="n">mccd_model</span><span class="o">.</span><span class="n">validation_stars</span><span class="p">(</span>
                        <span class="n">val_star_list</span><span class="p">[</span><span class="n">it</span><span class="p">],</span> <span class="n">val_pos_list</span><span class="p">[</span><span class="n">it</span><span class="p">],</span> <span class="n">val_mask_list</span><span class="p">[</span><span class="n">it</span><span class="p">],</span>
                        <span class="n">val_ccd_list</span><span class="p">[</span><span class="n">it</span><span class="p">],</span> <span class="n">mccd_debug</span><span class="o">=</span><span class="n">mccd_debug</span><span class="p">)</span>

                <span class="n">PSF_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deg_PSFs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">deg_PSFs_glob</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">PSF_glob_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deg_PSFs_glob</span><span class="p">)</span>
                    <span class="n">PSF_loc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deg_PSFs_loc</span><span class="p">)</span>

            <span class="n">star_dict</span><span class="p">[</span><span class="s1">'PSF_GLOB_VIGNET_LIST'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">PSF_glob_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">star_dict</span><span class="p">[</span><span class="s1">'PSF_LOC_VIGNET_LIST'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">PSF_loc_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">global_pol_interp</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">global_pol_interp</span><span class="p">:</span>
                <span class="n">interp_Pi</span> <span class="o">=</span> <span class="n">mccd_utils</span><span class="o">.</span><span class="n">interpolation_Pi</span><span class="p">(</span>
                    <span class="n">val_pos_list</span><span class="p">,</span> <span class="n">mccd_model</span><span class="o">.</span><span class="n">d_comp_glob</span><span class="p">)</span>

                <span class="n">PSF_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">mccd_model</span><span class="o">.</span><span class="n">validation_stars</span><span class="p">(</span>
                    <span class="n">_star</span><span class="p">,</span> <span class="n">_pos</span><span class="p">,</span> <span class="n">_mask</span><span class="p">,</span> <span class="n">_ccd_id</span><span class="p">,</span>
                    <span class="n">mccd_debug</span><span class="o">=</span><span class="n">mccd_debug</span><span class="p">,</span> <span class="n">global_pol_interp</span><span class="o">=</span><span class="n">_iterp_Pi</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">_star</span><span class="p">,</span> <span class="n">_pos</span><span class="p">,</span> <span class="n">_mask</span><span class="p">,</span> <span class="n">_ccd_id</span><span class="p">,</span> <span class="n">_iterp_Pi</span> <span class="ow">in</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">val_star_list</span><span class="p">,</span> <span class="n">val_pos_list</span><span class="p">,</span> <span class="n">val_mask_list</span><span class="p">,</span>
                        <span class="n">val_ccd_list</span><span class="p">,</span> <span class="n">interp_Pi</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">PSF_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">mccd_model</span><span class="o">.</span><span class="n">validation_stars</span><span class="p">(</span>
                    <span class="n">_star</span><span class="p">,</span> <span class="n">_pos</span><span class="p">,</span> <span class="n">_mask</span><span class="p">,</span> <span class="n">_ccd_id</span><span class="p">,</span> <span class="n">mccd_debug</span><span class="o">=</span><span class="n">mccd_debug</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">_star</span><span class="p">,</span> <span class="n">_pos</span><span class="p">,</span> <span class="n">_mask</span><span class="p">,</span> <span class="n">_ccd_id</span> <span class="ow">in</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">val_star_list</span><span class="p">,</span> <span class="n">val_pos_list</span><span class="p">,</span> <span class="n">val_mask_list</span><span class="p">,</span>
                        <span class="n">val_ccd_list</span><span class="p">)]</span>
    <span class="sd">"""</span>
<span class="sd">    # [TL] TEST</span>
<span class="sd">    # Checking how many CCDs would have been rejected.</span>
<span class="sd">    dim_x = val_star_list[0].shape[0]</span>
<span class="sd">    dim_y = val_star_list[0].shape[1]</span>
<span class="sd">    win_rad = np.floor(np.max([dim_x, dim_y]) / 3)</span>

<span class="sd">    ccd_star_thresh = 0.1</span>
<span class="sd">    rmse_thresh = 1.25</span>

<span class="sd">    # Calculate the observation noise</span>
<span class="sd">    noise_estimator = utils.NoiseEstimator((dim_x, dim_y), win_rad)</span>

<span class="sd">    ccd_outliers = []</span>

<span class="sd">    for k in range(len(val_star_list)):</span>
<span class="sd">        # Extract observations and reconstructions from the CCD</span>
<span class="sd">        stars = utils.reg_format(val_star_list[k])</span>
<span class="sd">        # Reconstruct the PSFs</span>
<span class="sd">        psfs = PSF_list[k]</span>

<span class="sd">        if psfs is not None:</span>
<span class="sd">            # Estimate noise</span>
<span class="sd">            sigmas_obs = np.array([noise_estimator.estimate_noise(star)</span>
<span class="sd">                            for star in stars])</span>

<span class="sd">            # Window to consider the central PSF only</span>
<span class="sd">            window = ~noise_estimator.window</span>

<span class="sd">            # Calculate the windowed RMSE normalized by the noise level</span>
<span class="sd">            rmse_sig = np.array([</span>
<span class="sd">                np.sqrt(np.mean(((_mod - _obs)**2)[window])) / _sig</span>
<span class="sd">                for _mod, _obs, _sig in zip(psfs, stars, sigmas_obs)</span>
<span class="sd">                                ])</span>

<span class="sd">            # Select outlier stars</span>
<span class="sd">            outlier_ids = rmse_sig &gt;= rmse_thresh</span>
<span class="sd">            num_outliers = np.sum(outlier_ids)</span>

<span class="sd">            # Check if the number of outliers depasses the star threshold</span>
<span class="sd">            num_stars = stars.shape[0]</span>
<span class="sd">            star_thresh_num = np.ceil(ccd_star_thresh * num_stars)</span>

<span class="sd">            print("CCD num %02d, \t %d outliers, \t%d stars,"</span>
<span class="sd">                    " \t%d star threshold number." % (</span>
<span class="sd">                        val_ccd_list[k], num_outliers, num_stars,</span>
<span class="sd">                        star_thresh_num))</span>

<span class="sd">            if num_outliers &gt; star_thresh_num:</span>
<span class="sd">                # We have to reject the CCD</span>
<span class="sd">                ccd_outliers.append(k)</span>
<span class="sd">                print('\nOutlier! CCD %d, \t%d outliers, \t%d tot stars.' % (</span>
<span class="sd">                    val_ccd_list[k], num_outliers, num_stars))</span>

<span class="sd">    # Remove all the outliers</span>
<span class="sd">    # for idx in sorted(ccd_outliers, reverse=True):</span>
<span class="sd">    #     del PSF_list[idx]</span>
<span class="sd">    #     del val_pos_list[idx]</span>
<span class="sd">    #     del val_star_list[idx]</span>
<span class="sd">    #     del val_mask_list[idx]</span>
<span class="sd">    #     del val_ccd_list[idx]</span>
<span class="sd">    #     if val_RA_list is not None:</span>
<span class="sd">    #         del val_RA_list[idx]</span>
<span class="sd">    #         del val_DEC_list[idx]</span>

<span class="sd">    # [TL] finish testing</span>
<span class="sd">    """</span>

    <span class="c1"># Remove the CCDs not used for training from ALL the lists</span>
    <span class="c1"># Identify the None elements on a boolean list</span>
    <span class="n">bad_ccds_bool</span> <span class="o">=</span> <span class="p">[</span><span class="n">psf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">psf</span> <span class="ow">in</span> <span class="n">PSF_list</span><span class="p">]</span>
    <span class="c1"># Get the True indexes</span>
    <span class="n">bad_ccds_indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bad_ccds_bool</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span>
    <span class="c1"># Delete the None elements from the lists from the last to the first one</span>
    <span class="c1"># not to mess up with the order</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">bad_ccds_indexes</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">PSF_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">val_pos_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">val_star_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">val_mask_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">val_ccd_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">val_RA_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">val_RA_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">val_DEC_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="c1"># Have the PSFs in rca format, to match the stars</span>
    <span class="n">PSF_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">rca_format</span><span class="p">(</span><span class="n">psfs</span><span class="p">)</span> <span class="k">for</span> <span class="n">psfs</span> <span class="ow">in</span> <span class="n">PSF_list</span><span class="p">]</span>

    <span class="c1"># Calculate moments</span>
    <span class="n">star_shapes_list</span><span class="p">,</span> <span class="n">psf_shapes_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">psf_vignet_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pos_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">star_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mask_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ccd_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">RA_list</span><span class="p">,</span> <span class="n">DEC_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val_star_list</span><span class="p">)):</span>
        <span class="c1"># For each ccd</span>
        <span class="n">test_stars</span> <span class="o">=</span> <span class="n">val_star_list</span><span class="p">[</span><span class="n">it</span><span class="p">]</span>
        <span class="c1"># Galsim's HSM bad pixel convetion thinks 0 means good</span>
        <span class="n">badpix_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">val_mask_list</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">matched_psfs</span> <span class="o">=</span> <span class="n">PSF_list</span><span class="p">[</span><span class="n">it</span><span class="p">]</span>

        <span class="c1"># Stars</span>
        <span class="n">star_moms</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs</span><span class="o">.</span><span class="n">hsm</span><span class="o">.</span><span class="n">FindAdaptiveMom</span><span class="p">(</span>
            <span class="n">gs</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">star</span><span class="p">),</span> <span class="n">badpix</span><span class="o">=</span><span class="n">gs</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">bp</span><span class="p">),</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">star</span><span class="p">,</span> <span class="n">bp</span> <span class="ow">in</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">reg_format</span><span class="p">(</span><span class="n">test_stars</span><span class="p">),</span> <span class="n">utils</span><span class="o">.</span><span class="n">reg_format</span><span class="p">(</span><span class="n">badpix_mask</span><span class="p">))]</span>
        <span class="n">star_shapes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">moms</span><span class="o">.</span><span class="n">observed_shape</span><span class="o">.</span><span class="n">g1</span><span class="p">,</span>
                                 <span class="n">moms</span><span class="o">.</span><span class="n">observed_shape</span><span class="o">.</span><span class="n">g2</span><span class="p">,</span>
                                 <span class="n">moms</span><span class="o">.</span><span class="n">moments_sigma</span><span class="p">,</span>
                                 <span class="nb">int</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">moms</span><span class="o">.</span><span class="n">error_message</span><span class="p">))]</span>
                                <span class="k">for</span> <span class="n">moms</span> <span class="ow">in</span> <span class="n">star_moms</span><span class="p">])</span>
        <span class="c1"># PSFs</span>
        <span class="n">psf_moms</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs</span><span class="o">.</span><span class="n">hsm</span><span class="o">.</span><span class="n">FindAdaptiveMom</span><span class="p">(</span><span class="n">gs</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">psf</span><span class="p">),</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">psf</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">reg_format</span><span class="p">(</span><span class="n">matched_psfs</span><span class="p">)]</span>
        <span class="n">psf_shapes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">moms</span><span class="o">.</span><span class="n">observed_shape</span><span class="o">.</span><span class="n">g1</span><span class="p">,</span>
                                <span class="n">moms</span><span class="o">.</span><span class="n">observed_shape</span><span class="o">.</span><span class="n">g2</span><span class="p">,</span>
                                <span class="n">moms</span><span class="o">.</span><span class="n">moments_sigma</span><span class="p">,</span>
                                <span class="nb">int</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">moms</span><span class="o">.</span><span class="n">error_message</span><span class="p">))]</span>
                               <span class="k">for</span> <span class="n">moms</span> <span class="ow">in</span> <span class="n">psf_moms</span><span class="p">])</span>

        <span class="n">star_shapes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">star_shapes</span><span class="p">)</span>
        <span class="n">psf_shapes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psf_shapes</span><span class="p">)</span>
        <span class="n">psf_vignet_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">reg_format</span><span class="p">(</span><span class="n">matched_psfs</span><span class="p">))</span>
        <span class="n">pos_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_pos_list</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
        <span class="n">star_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">reg_format</span><span class="p">(</span><span class="n">val_star_list</span><span class="p">[</span><span class="n">it</span><span class="p">]))</span>
        <span class="n">mask_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">reg_format</span><span class="p">(</span><span class="n">val_mask_list</span><span class="p">[</span><span class="n">it</span><span class="p">]))</span>
        <span class="n">ccd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_ccd_list_to_save</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">val_RA_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">RA_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_RA_list</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
            <span class="n">DEC_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_DEC_list</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>

    <span class="c1"># Prepare the PSF list and the moments in an array form</span>
    <span class="c1"># To be able to save them in the fits format</span>
    <span class="n">psf_shapes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">psf_shapes_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">star_shapes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">star_shapes_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">psf_vignets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">psf_vignet_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pos_ordered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">pos_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">star_ordered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">star_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mask_ordered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">mask_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ccd_ordered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ccd_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">val_RA_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">RA_ordered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">RA_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">DEC_ordered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">DEC_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Save the results and the psfs</span>
    <span class="n">star_dict</span><span class="p">[</span><span class="s1">'PSF_VIGNET_LIST'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">psf_vignets</span><span class="p">)</span>
    <span class="n">star_dict</span><span class="p">[</span><span class="s1">'PSF_MOM_LIST'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">psf_shapes</span><span class="p">)</span>
    <span class="n">star_dict</span><span class="p">[</span><span class="s1">'STAR_MOM_LIST'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">star_shapes</span><span class="p">)</span>
    <span class="n">star_dict</span><span class="p">[</span><span class="s1">'GLOB_POSITION_IMG_LIST'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pos_ordered</span><span class="p">)</span>
    <span class="n">star_dict</span><span class="p">[</span><span class="s1">'VIGNET_LIST'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">star_ordered</span><span class="p">)</span>
    <span class="n">star_dict</span><span class="p">[</span><span class="s1">'MASK_LIST'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mask_ordered</span><span class="p">)</span>
    <span class="n">star_dict</span><span class="p">[</span><span class="s1">'CCD_ID_LIST'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ccd_ordered</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">val_RA_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">star_dict</span><span class="p">[</span><span class="s1">'RA_LIST'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">RA_ordered</span><span class="p">)</span>
        <span class="n">star_dict</span><span class="p">[</span><span class="s1">'DEC_LIST'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">DEC_ordered</span><span class="p">)</span>

    <span class="c1"># Memory management</span>
    <span class="k">del</span> <span class="n">mccd_model</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">star_dict</span></div>


<div class="viewcode-block" id="mccd_preprocessing"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.mccd_preprocessing">[docs]</a><span class="k">def</span> <span class="nf">mccd_preprocessing</span><span class="p">(</span><span class="n">input_folder_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">min_n_stars</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                       <span class="n">file_pattern</span><span class="o">=</span><span class="s1">'sexcat-*-*.fits'</span><span class="p">,</span>
                       <span class="n">separator</span><span class="o">=</span><span class="s1">'-'</span><span class="p">,</span>
                       <span class="n">CCD_id_filter_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">outlier_std_max</span><span class="o">=</span><span class="mf">100.</span><span class="p">,</span>
                       <span class="n">save_masks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">save_name</span><span class="o">=</span><span class="s1">'train_star_selection'</span><span class="p">,</span>
                       <span class="n">save_extension</span><span class="o">=</span><span class="s1">'.fits'</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">"""Preprocess input catalog.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_folder_path: str</span>
<span class="sd">        Path to the folder containing the files to preprocess.</span>
<span class="sd">    output_path: str</span>
<span class="sd">        Path to the folder where to save the preprocessed files.</span>
<span class="sd">    min_n_stars: int</span>
<span class="sd">        Minimum number of stars in order to preprocess the CCD.</span>
<span class="sd">        Default is ``20``.</span>
<span class="sd">    file_pattern: str</span>
<span class="sd">        Input file pattern as a regex expression. Only the files matching</span>
<span class="sd">        the ``file_pattern`` in ``input_folder_path`` will be treated.</span>
<span class="sd">        Default is ``sexcat-*-*.fits``. Where the first `*` corresponds to</span>
<span class="sd">        the catalog_id, the second `*` corresponds to the CCD id and they are</span>
<span class="sd">        separated by the ``separator``.</span>
<span class="sd">    separator: str</span>
<span class="sd">        Separator string that separates the catalog id and the CCD id.</span>
<span class="sd">        Default is ``'-'``.</span>
<span class="sd">    CCD_id_filter_list: list of int or None</span>
<span class="sd">        A list that correspond to the CCDs that should be preprocessed.</span>
<span class="sd">        If it is None, all the CCDs are preprocessed.</span>
<span class="sd">        (Current version: Hardcoded for the MegaCam scenario).</span>
<span class="sd">        Default is ``None``.</span>
<span class="sd">    outlier_std_max: float</span>
<span class="sd">        Parameter regulating the shape outlier removal. Default is very high</span>
<span class="sd">        so as it is not done at all. A decent number would be ``10``.</span>
<span class="sd">        Default is ``100.``.</span>
<span class="sd">    save_masks: bool</span>
<span class="sd">        If masks should be saved in the new file.</span>
<span class="sd">        Default is ``True``.</span>
<span class="sd">    save_name: str</span>
<span class="sd">        Name to save the preprocessed file.</span>
<span class="sd">        Default is ``'train_star_selection'``.</span>
<span class="sd">    save_extension: str</span>
<span class="sd">        Extension of the saved file.</span>
<span class="sd">        Default is ``.fits``.</span>
<span class="sd">    verbose: bool</span>
<span class="sd">        Verbose mode.</span>
<span class="sd">        Default is ``True``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mccd_inputs: class</span>
<span class="sd">        An instance of ``MccdInputs`` class used for the input preprocessing.</span>

<span class="sd">    """</span>
    <span class="n">mccd_star_nb</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">CCD_id_filter_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">CCD_id_filter_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">CCD_id_filter_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">CCD_id_filter_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">print_fun</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">print_fun</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">pass</span>

    <span class="c1"># Preprocess</span>
    <span class="n">mccd_inputs</span> <span class="o">=</span> <span class="n">mccd_utils</span><span class="o">.</span><span class="n">MccdInputs</span><span class="p">(</span><span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">)</span>
    <span class="n">print_fun</span><span class="p">(</span><span class="s1">'Processing dataset..'</span><span class="p">)</span>
    <span class="n">catalog_ids</span> <span class="o">=</span> <span class="n">mccd_inputs</span><span class="o">.</span><span class="n">preprocess_data</span><span class="p">(</span><span class="n">folder_path</span><span class="o">=</span><span class="n">input_folder_path</span><span class="p">,</span>
                                              <span class="n">pattern</span><span class="o">=</span><span class="n">file_pattern</span><span class="p">)</span>

    <span class="c1"># Loop over the catalogs</span>
    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">catalog_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># For each observation position</span>
        <span class="n">catalog_id</span> <span class="o">=</span> <span class="n">catalog_ids</span><span class="p">[</span><span class="n">it</span><span class="p">]</span>
        <span class="n">star_list</span><span class="p">,</span> <span class="n">pos_list</span><span class="p">,</span> <span class="n">mask_list</span><span class="p">,</span> <span class="n">ccd_list</span><span class="p">,</span> <span class="n">SNR_list</span><span class="p">,</span> <span class="n">RA_list</span><span class="p">,</span> \
            <span class="n">DEC_list</span> <span class="o">=</span> <span class="n">mccd_inputs</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="n">catalog_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">outlier_std_max</span> <span class="o">&lt;</span> <span class="mi">99</span><span class="p">:</span>
            <span class="n">star_list</span><span class="p">,</span> <span class="n">pos_list</span><span class="p">,</span> <span class="n">mask_list</span><span class="p">,</span> <span class="n">ccd_list</span><span class="p">,</span> <span class="n">SNR_list</span><span class="p">,</span> <span class="n">RA_list</span><span class="p">,</span> \
                <span class="n">DEC_list</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mccd_inputs</span><span class="o">.</span><span class="n">outlier_rejection</span><span class="p">(</span>
                    <span class="n">star_list</span><span class="p">,</span> <span class="n">pos_list</span><span class="p">,</span> <span class="n">mask_list</span><span class="p">,</span> <span class="n">ccd_list</span><span class="p">,</span> <span class="n">SNR_list</span><span class="p">,</span>
                    <span class="n">RA_list</span><span class="p">,</span> <span class="n">DEC_list</span><span class="p">,</span> <span class="n">shape_std_max</span><span class="o">=</span><span class="n">outlier_std_max</span><span class="p">,</span>
                    <span class="n">print_fun</span><span class="o">=</span><span class="n">print_fun</span><span class="p">)</span>

        <span class="n">mccd_star_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mccd_pos_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mccd_mask_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mccd_ccd_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mccd_SNR_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mccd_RA_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mccd_DEC_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">star_list</span><span class="p">)):</span>
            <span class="c1"># For each CCD</span>
            <span class="k">if</span> <span class="n">ccd_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CCD_id_filter_list</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">n_stars</span> <span class="o">=</span> <span class="n">star_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">n_stars</span> <span class="o">&gt;=</span> <span class="n">min_n_stars</span><span class="p">:</span>
                        <span class="n">mccd_star_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">star_list</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                        <span class="n">mccd_pos_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_list</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                        <span class="n">mccd_mask_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask_list</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                        <span class="n">mccd_ccd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ccd_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_stars</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">SNR_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">mccd_SNR_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SNR_list</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">RA_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">mccd_RA_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RA_list</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                            <span class="n">mccd_DEC_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DEC_list</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s1">'''Not enough stars in catalog_id </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">                            ,ccd </span><span class="si">%d</span><span class="s1">. Total stars = </span><span class="si">%d</span><span class="s1">'''</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">catalog_id</span><span class="p">,</span> <span class="n">ccd_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">n_stars</span><span class="p">)</span>
                        <span class="n">print_fun</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">'''Warning! Problem detected in</span>
<span class="s1">                        catalog_id </span><span class="si">%s</span><span class="s1"> ,ccd </span><span class="si">%d</span><span class="s1">'''</span> <span class="o">%</span> <span class="p">(</span><span class="n">catalog_id</span><span class="p">,</span> <span class="n">ccd_list</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                    <span class="n">print_fun</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mccd_pos_list</span><span class="p">:</span>
            <span class="c1"># If the list is not empty</span>
            <span class="c1"># Concatenate, as fits can't handle list of numpy arrays and</span>
            <span class="c1"># turn into reg format</span>
            <span class="n">mccd_stars</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">reg_format</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">mccd_star_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">mccd_poss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">mccd_pos_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">mccd_ccds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">mccd_ccd_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">save_masks</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">mccd_masks</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">reg_format</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">mccd_mask_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Send an array of False (None cannot be used in .fits)</span>
                <span class="n">mccd_masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mccd_poss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">SNR_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mccd_SNRs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">mccd_SNR_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Send an array of False (None cannot be used in .fits)</span>
                <span class="n">mccd_SNRs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mccd_poss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">RA_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mccd_RAs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">mccd_RA_list</span><span class="p">)</span>
                <span class="n">mccd_DECs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">mccd_DEC_list</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mccd_RAs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mccd_poss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                <span class="n">mccd_DECs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mccd_poss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

            <span class="n">mccd_star_nb</span> <span class="o">+=</span> <span class="n">mccd_stars</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Save the fits file</span>
            <span class="n">train_dic</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'VIGNET_LIST'</span><span class="p">:</span> <span class="n">mccd_stars</span><span class="p">,</span>
                         <span class="s1">'GLOB_POSITION_IMG_LIST'</span><span class="p">:</span> <span class="n">mccd_poss</span><span class="p">,</span>
                         <span class="s1">'MASK_LIST'</span><span class="p">:</span> <span class="n">mccd_masks</span><span class="p">,</span> <span class="s1">'CCD_ID_LIST'</span><span class="p">:</span> <span class="n">mccd_ccds</span><span class="p">,</span>
                         <span class="s1">'SNR_WIN_LIST'</span><span class="p">:</span> <span class="n">mccd_SNRs</span><span class="p">,</span>
                         <span class="s1">'RA_LIST'</span><span class="p">:</span> <span class="n">mccd_RAs</span><span class="p">,</span> <span class="s1">'DEC_LIST'</span><span class="p">:</span> <span class="n">mccd_DECs</span><span class="p">}</span>

            <span class="n">saving_path</span> <span class="o">=</span> <span class="n">output_path</span> <span class="o">+</span> <span class="n">save_name</span> <span class="o">+</span> <span class="n">separator</span> \
                <span class="o">+</span> <span class="n">catalog_id</span> <span class="o">+</span> <span class="n">save_extension</span>
            <span class="n">mccd_utils</span><span class="o">.</span><span class="n">save_to_fits</span><span class="p">(</span><span class="n">train_dic</span><span class="p">,</span> <span class="n">saving_path</span><span class="p">)</span>

    <span class="n">print_fun</span><span class="p">(</span><span class="s1">'Finished the training dataset processing.'</span><span class="p">)</span>
    <span class="n">print_fun</span><span class="p">(</span><span class="s1">'Total stars processed = </span><span class="si">%d</span><span class="s1">'</span> <span class="o">%</span> <span class="n">mccd_star_nb</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mccd_inputs</span></div>


<div class="viewcode-block" id="MCCDParamsParser"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.MCCDParamsParser">[docs]</a><span class="k">class</span> <span class="nc">MCCDParamsParser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">"""Parse MCCD config file.</span>

<span class="sd">    Set up a parser for the MCCD parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file_path: str</span>
<span class="sd">        Path to the config file.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    IOError</span>
<span class="sd">        For non existent configuration file.</span>

<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Initialize class."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">'Configuration file </span><span class="si">{}</span><span class="s1"> does not exist.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">file_path</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">file_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">processed_inputs</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inst_kw</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mccd_fit_kw</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inputs_kw</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mccd_val_kw</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mccd_val_prepro_kw</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mccd_extra_kw</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_set_inputs_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Set Input Options.</span>

<span class="sd">        This method checks the ``INPUTS`` options in the configuration file.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            For no input directory specified</span>
<span class="sd">        OSError</span>
<span class="sd">            For non-existent input directory</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            For no output directory specified</span>
<span class="sd">        OSError</span>
<span class="sd">            For non-existent output directory</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'OUTPUT_DIR'</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">'Not output directory specified.'</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INPUTS'</span><span class="p">][</span><span class="s1">'OUTPUT_DIR'</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">'Directory </span><span class="si">{}</span><span class="s1"> not found.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'OUTPUT_DIR'</span><span class="p">)))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'PREPROCESSED_OUTPUT_DIR'</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">'Not preprocessed output directory specified.'</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INPUTS'</span><span class="p">][</span><span class="s1">'PREPROCESSED_OUTPUT_DIR'</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">'Directory </span><span class="si">{}</span><span class="s1"> not found.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'PREPROCESSED_OUTPUT_DIR'</span><span class="p">)))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'INPUT_DIR'</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">'Not output directory specified.'</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INPUTS'</span><span class="p">][</span><span class="s1">'INPUT_DIR'</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">'Directory </span><span class="si">{}</span><span class="s1"> not found.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'INPUT_DIR'</span><span class="p">)))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'INPUT_REGEX_FILE_PATTERN'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'INPUT_REGEX_FILE_PATTERN'</span><span class="p">,</span>
                            <span class="s1">'sexcat-*-*.fits'</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'INPUT_SEPARATOR'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'INPUT_SEPARATOR'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'MIN_N_STARS'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'MIN_N_STARS'</span><span class="p">,</span> <span class="s1">'20'</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'OUTLIER_STD_MAX'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'OUTLIER_STD_MAX'</span><span class="p">,</span> <span class="s1">'100.'</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'USE_SNR_WEIGHTS'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'USE_SNR_WEIGHTS'</span><span class="p">,</span> <span class="s1">'False'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_instance_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Set Instance Options.</span>

<span class="sd">        This method checks the ``INSTANCE`` options in the configuration file.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INSTANCE'</span><span class="p">,</span> <span class="s1">'N_COMP_LOC'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'INSTANCE'</span><span class="p">,</span> <span class="s1">'N_COMP_LOC'</span><span class="p">,</span> <span class="s1">'6'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INSTANCE'</span><span class="p">,</span> <span class="s1">'D_COMP_GLOB'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'INSTANCE'</span><span class="p">,</span> <span class="s1">'D_COMP_GLOB'</span><span class="p">,</span> <span class="s1">'8'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INSTANCE'</span><span class="p">,</span> <span class="s1">'KSIG_LOC'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'INSTANCE'</span><span class="p">,</span> <span class="s1">'KSIG_LOC'</span><span class="p">,</span> <span class="s1">'0.0'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INSTANCE'</span><span class="p">,</span> <span class="s1">'KSIG_GLOB'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'INSTANCE'</span><span class="p">,</span> <span class="s1">'KSIG_GLOB'</span><span class="p">,</span> <span class="s1">'0.0'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INSTANCE'</span><span class="p">,</span> <span class="s1">'FILTER_PATH'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'INSTANCE'</span><span class="p">,</span> <span class="s1">'FILTER_PATH'</span><span class="p">,</span> <span class="s1">'None'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INSTANCE'</span><span class="p">,</span> <span class="s1">'D_HYB_LOC'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'INSTANCE'</span><span class="p">,</span> <span class="s1">'D_HYB_LOC'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INSTANCE'</span><span class="p">,</span> <span class="s1">'MIN_D_COMP_GLOB'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'INSTANCE'</span><span class="p">,</span> <span class="s1">'MIN_D_COMP_GLOB'</span><span class="p">,</span> <span class="s1">'None'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INSTANCE'</span><span class="p">,</span> <span class="s1">'CCD_STAR_THRESH'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'INSTANCE'</span><span class="p">,</span> <span class="s1">'CCD_STAR_THRESH'</span><span class="p">,</span> <span class="s1">'0.15'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INSTANCE'</span><span class="p">,</span> <span class="s1">'RMSE_THRESH'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'INSTANCE'</span><span class="p">,</span> <span class="s1">'RMSE_THRESH'</span><span class="p">,</span> <span class="s1">'1.25'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_fit_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Set Fit Options.</span>

<span class="sd">        This method checks the ``FIT`` options in the configuration file.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'PSF_SIZE'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'PSF_SIZE'</span><span class="p">,</span> <span class="s1">'6.15'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'PSF_SIZE_TYPE'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'PSF_SIZE_TYPE'</span><span class="p">,</span> <span class="s1">'R2'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'N_EIGENVECTS'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'N_EIGENVECTS'</span><span class="p">,</span> <span class="s1">'5'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'N_ITER_RCA'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'N_ITER_RCA'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'N_ITER_GLOB'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'N_ITER_GLOB'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'N_ITER_LOC'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'N_ITER_LOC'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'NB_SUBITER_S_LOC'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'NB_SUBITER_S_LOC'</span><span class="p">,</span> <span class="s1">'100'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'NB_SUBITER_A_LOC'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'NB_SUBITER_A_LOC'</span><span class="p">,</span> <span class="s1">'500'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'NB_SUBITER_S_GLOB'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'NB_SUBITER_S_GLOB'</span><span class="p">,</span> <span class="s1">'30'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'NB_SUBITER_A_GLOB'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'NB_SUBITER_A_GLOB'</span><span class="p">,</span> <span class="s1">'200'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'LOC_MODEL'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'FIT'</span><span class="p">,</span> <span class="s1">'LOC_MODEL'</span><span class="p">,</span> <span class="s1">'hybrid'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_val_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Set Validation Options.</span>

<span class="sd">        Method to check the ``VALIDATION`` options in the configuration file.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            For no input directory specified</span>
<span class="sd">        OSError</span>
<span class="sd">            For non-existent input directory</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            For no output directory specified</span>
<span class="sd">        OSError</span>
<span class="sd">            For non-existent output directory</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'VALIDATION'</span><span class="p">,</span> <span class="s1">'VAL_MODEL_INPUT_DIR'</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">'Not input model directory specified.'</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'VALIDATION'</span><span class="p">][</span>
                                   <span class="s1">'VAL_MODEL_INPUT_DIR'</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">'Directory </span><span class="si">{}</span><span class="s1"> not found.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'VALIDATION'</span><span class="p">,</span> <span class="s1">'VAL_MODEL_INPUT_DIR'</span><span class="p">)))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'VALIDATION'</span><span class="p">,</span> <span class="s1">'VAL_DATA_INPUT_DIR'</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">'Not input dataset directory specified.'</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'VALIDATION'</span><span class="p">][</span><span class="s1">'VAL_DATA_INPUT_DIR'</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">'Directory </span><span class="si">{}</span><span class="s1"> not found.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'VALIDATION'</span><span class="p">,</span> <span class="s1">'VAL_DATA_INPUT_DIR'</span><span class="p">)))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'VALIDATION'</span><span class="p">,</span> <span class="s1">'VAL_OUTPUT_DIR'</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">'Not validation output directory specified.'</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'VALIDATION'</span><span class="p">][</span><span class="s1">'VAL_OUTPUT_DIR'</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">'Directory </span><span class="si">{}</span><span class="s1"> not found.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'VALIDATION'</span><span class="p">,</span> <span class="s1">'VAL_OUTPUT_DIR'</span><span class="p">)))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'VALIDATION'</span><span class="p">,</span>
                                      <span class="s1">'VAL_PREPROCESSED_OUTPUT_DIR'</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">'''Not validation preprocessing output</span>
<span class="s1">            directory specified.'''</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'VALIDATION'</span><span class="p">][</span>
                                   <span class="s1">'VAL_PREPROCESSED_OUTPUT_DIR'</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">'Directory </span><span class="si">{}</span><span class="s1"> not found.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'VALIDATION'</span><span class="p">,</span>
                                       <span class="s1">'VAL_PREPROCESSED_OUTPUT_DIR'</span><span class="p">)))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'VAL_REGEX_FILE_PATTERN'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'VAL_REGEX_FILE_PATTERN'</span><span class="p">,</span>
                            <span class="s1">'test-star_selection-*-*.fits'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'VAL_SEPARATOR'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'VAL_SEPARATOR'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'APPLY_DEGRADATION'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'APPLY_DEGRADATION'</span><span class="p">,</span> <span class="s1">'True'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'MCCD_DEBUG'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'MCCD_DEBUG'</span><span class="p">,</span> <span class="s1">'False'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'GLOBAL_POL_INTERP'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'INPUTS'</span><span class="p">,</span> <span class="s1">'GLOBAL_POL_INTERP'</span><span class="p">,</span> <span class="s1">'False'</span><span class="p">)</span>

<div class="viewcode-block" id="MCCDParamsParser.parse_document"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.MCCDParamsParser.parse_document">[docs]</a>    <span class="k">def</span> <span class="nf">parse_document</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Parse config file."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_inputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_inputs_options</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_instance_options</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_fit_options</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_val_options</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processed_inputs</span> <span class="o">=</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_build_instance_kw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Build ``INSTANCE`` parameter dictionary."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_inputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_document</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inst_kw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_comp_loc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INSTANCE'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'N_COMP_LOC'</span><span class="p">))</span>
            <span class="n">d_comp_glob</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INSTANCE'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'D_COMP_GLOB'</span><span class="p">))</span>
            <span class="n">ksig_loc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INSTANCE'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'KSIG_LOC'</span><span class="p">))</span>
            <span class="n">ksig_glob</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INSTANCE'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'KSIG_GLOB'</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INSTANCE'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'FILTER_PATH'</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'None'</span><span class="p">:</span>
                <span class="n">filters</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INSTANCE'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'FILTER_PATH'</span><span class="p">)</span>
            <span class="n">d_hyb_loc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INSTANCE'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'D_HYB_LOC'</span><span class="p">))</span>
            <span class="n">ccd_star_thresh</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INSTANCE'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'CCD_STAR_THRESH'</span><span class="p">))</span>
            <span class="n">rmse_thresh</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INSTANCE'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'RMSE_THRESH'</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INSTANCE'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'MIN_D_COMP_GLOB'</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'None'</span><span class="p">:</span>
                <span class="n">min_d_comp_glob</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">min_d_comp_glob</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INSTANCE'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'MIN_D_COMP_GLOB'</span><span class="p">))</span>

            <span class="c1"># Build the parameter dictionaries</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inst_kw</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'n_comp_loc'</span><span class="p">:</span> <span class="n">n_comp_loc</span><span class="p">,</span>
                                 <span class="s1">'d_comp_glob'</span><span class="p">:</span> <span class="n">d_comp_glob</span><span class="p">,</span>
                                 <span class="s1">'d_hyb_loc'</span><span class="p">:</span> <span class="n">d_hyb_loc</span><span class="p">,</span>
                                 <span class="s1">'min_d_comp_glob'</span><span class="p">:</span> <span class="n">min_d_comp_glob</span><span class="p">,</span>
                                 <span class="s1">'filters'</span><span class="p">:</span> <span class="n">filters</span><span class="p">,</span>
                                 <span class="s1">'ksig_loc'</span><span class="p">:</span> <span class="n">ksig_loc</span><span class="p">,</span>
                                 <span class="s1">'ksig_glob'</span><span class="p">:</span> <span class="n">ksig_glob</span><span class="p">,</span>
                                 <span class="s1">'rmse_thresh'</span><span class="p">:</span> <span class="n">rmse_thresh</span><span class="p">,</span>
                                 <span class="s1">'ccd_star_thresh'</span><span class="p">:</span> <span class="n">ccd_star_thresh</span>
                                 <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_build_fit_kw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Build ``FIT`` parameter dictionary."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_inputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_document</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_fit_kw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">psf_size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'FIT'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'PSF_SIZE'</span><span class="p">))</span>
            <span class="n">psf_size_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'FIT'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'PSF_SIZE_TYPE'</span><span class="p">)</span>
            <span class="n">n_eigenvects</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'FIT'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'N_EIGENVECTS'</span><span class="p">))</span>
            <span class="n">n_iter_rca</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'FIT'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'N_ITER_RCA'</span><span class="p">))</span>
            <span class="n">nb_iter_glob</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'FIT'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'N_ITER_GLOB'</span><span class="p">))</span>
            <span class="n">nb_iter_loc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'FIT'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'N_ITER_LOC'</span><span class="p">))</span>
            <span class="n">nb_subit_S_loc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'FIT'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'NB_SUBITER_S_LOC'</span><span class="p">))</span>
            <span class="n">nb_subit_A_loc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'FIT'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'NB_SUBITER_A_LOC'</span><span class="p">))</span>
            <span class="n">nb_subit_S_glob</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'FIT'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'NB_SUBITER_S_GLOB'</span><span class="p">))</span>
            <span class="n">nb_subit_A_glob</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'FIT'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'NB_SUBITER_A_GLOB'</span><span class="p">))</span>
            <span class="n">loc_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'FIT'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'LOC_MODEL'</span><span class="p">)</span>

            <span class="c1"># Build the parameter dictionaries</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mccd_fit_kw</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'psf_size'</span><span class="p">:</span> <span class="n">psf_size</span><span class="p">,</span>
                                <span class="s1">'psf_size_type'</span><span class="p">:</span> <span class="n">psf_size_type</span><span class="p">,</span>
                                <span class="s1">'n_eigenvects'</span><span class="p">:</span> <span class="n">n_eigenvects</span><span class="p">,</span>
                                <span class="s1">'nb_iter'</span><span class="p">:</span> <span class="n">n_iter_rca</span><span class="p">,</span>
                                <span class="s1">'nb_iter_glob'</span><span class="p">:</span> <span class="n">nb_iter_glob</span><span class="p">,</span>
                                <span class="s1">'nb_iter_loc'</span><span class="p">:</span> <span class="n">nb_iter_loc</span><span class="p">,</span>
                                <span class="s1">'nb_subiter_S_loc'</span><span class="p">:</span> <span class="n">nb_subit_S_loc</span><span class="p">,</span>
                                <span class="s1">'nb_subiter_A_loc'</span><span class="p">:</span> <span class="n">nb_subit_A_loc</span><span class="p">,</span>
                                <span class="s1">'nb_subiter_S_glob'</span><span class="p">:</span> <span class="n">nb_subit_S_glob</span><span class="p">,</span>
                                <span class="s1">'nb_subiter_A_glob'</span><span class="p">:</span> <span class="n">nb_subit_A_glob</span><span class="p">,</span>
                                <span class="s1">'loc_model'</span><span class="p">:</span> <span class="n">loc_model</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_build_inputs_kw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Build ``INPUTS`` parameter dictionary."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_inputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_document</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inputs_kw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_folder_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INPUTS'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'INPUT_DIR'</span><span class="p">)</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INPUTS'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'PREPROCESSED_OUTPUT_DIR'</span><span class="p">)</span>
            <span class="n">min_n_stars</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INPUTS'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'MIN_N_STARS'</span><span class="p">))</span>
            <span class="n">file_pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INPUTS'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">'INPUT_REGEX_FILE_PATTERN'</span><span class="p">)</span>
            <span class="n">separator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INPUTS'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'INPUT_SEPARATOR'</span><span class="p">)</span>
            <span class="n">outlier_std_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INPUTS'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">'OUTLIER_STD_MAX'</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INPUTS'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'USE_SNR_WEIGHTS'</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'True'</span><span class="p">:</span>
                <span class="n">use_SNR_weight</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INPUTS'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'USE_SNR_WEIGHTS'</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'False'</span><span class="p">:</span>
                <span class="n">use_SNR_weight</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">'USE_SNR_WEIGHTS should be True or False.'</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inputs_kw</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'input_folder_path'</span><span class="p">:</span> <span class="n">input_folder_path</span><span class="p">,</span>
                                   <span class="s1">'output_path'</span><span class="p">:</span> <span class="n">output_path</span><span class="p">,</span>
                                   <span class="s1">'min_n_stars'</span><span class="p">:</span> <span class="n">min_n_stars</span><span class="p">,</span>
                                   <span class="s1">'file_pattern'</span><span class="p">:</span> <span class="n">file_pattern</span><span class="p">,</span>
                                   <span class="s1">'separator'</span><span class="p">:</span> <span class="n">separator</span><span class="p">,</span>
                                   <span class="s1">'outlier_std_max'</span><span class="p">:</span> <span class="n">outlier_std_max</span><span class="p">,</span>
                                   <span class="s1">'save_name'</span><span class="p">:</span> <span class="s1">'train_star_selection'</span><span class="p">,</span>
                                   <span class="s1">'save_extension'</span><span class="p">:</span> <span class="s1">'.fits'</span><span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mccd_extra_kw</span><span class="p">[</span><span class="s1">'use_SNR_weight'</span><span class="p">]</span> <span class="o">=</span> <span class="n">use_SNR_weight</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mccd_extra_kw</span><span class="p">[</span><span class="s1">'output_dir'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INPUTS'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">'OUTPUT_DIR'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_val_kw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Build ``VALIDATION`` parameter dictionary."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_inputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_document</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_val_kw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'VALIDATION'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'APPLY_DEGRADATION'</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'True'</span><span class="p">:</span>
                <span class="n">apply_degradation</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'VALIDATION'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'APPLY_DEGRADATION'</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'False'</span><span class="p">:</span>
                <span class="n">apply_degradation</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">'APPLY_DEGRADATION must be True or False.'</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'VALIDATION'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'MCCD_DEBUG'</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'True'</span><span class="p">:</span>
                <span class="n">mccd_debug</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'VALIDATION'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'MCCD_DEBUG'</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'False'</span><span class="p">:</span>
                <span class="n">mccd_debug</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">'MCCD_DEBUG must be True or False.'</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'VALIDATION'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'GLOBAL_POL_INTERP'</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'True'</span><span class="p">:</span>
                <span class="n">global_pol_interp</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'VALIDATION'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'GLOBAL_POL_INTERP'</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'False'</span><span class="p">:</span>
                <span class="n">global_pol_interp</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">'GLOBAL_POL_INTERP must be True or False.'</span><span class="p">)</span>

            <span class="c1"># Build the parameter dictionaries</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mccd_val_kw</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'apply_degradation'</span><span class="p">:</span> <span class="n">apply_degradation</span><span class="p">,</span>
                                <span class="s1">'mccd_debug'</span><span class="p">:</span> <span class="n">mccd_debug</span><span class="p">,</span>
                                <span class="s1">'global_pol_interp'</span><span class="p">:</span> <span class="n">global_pol_interp</span><span class="p">}</span>

            <span class="n">val_input_folder_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'VALIDATION'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">'VAL_DATA_INPUT_DIR'</span><span class="p">)</span>
            <span class="n">val_output_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'VALIDATION'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">'VAL_PREPROCESSED_OUTPUT_DIR'</span><span class="p">)</span>
            <span class="n">val_file_pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'VALIDATION'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">'VAL_REGEX_FILE_PATTERN'</span><span class="p">)</span>
            <span class="n">val_separator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'VALIDATION'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'VAL_SEPARATOR'</span><span class="p">)</span>
            <span class="n">outlier_std_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'INPUTS'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">'OUTLIER_STD_MAX'</span><span class="p">))</span>

            <span class="c1"># Build the preprocessing validatoin parameter dictionaries</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mccd_val_prepro_kw</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">'input_folder_path'</span><span class="p">:</span> <span class="n">val_input_folder_path</span><span class="p">,</span>
                <span class="s1">'output_path'</span><span class="p">:</span> <span class="n">val_output_path</span><span class="p">,</span>
                <span class="s1">'min_n_stars'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">'file_pattern'</span><span class="p">:</span> <span class="n">val_file_pattern</span><span class="p">,</span>
                <span class="s1">'separator'</span><span class="p">:</span> <span class="n">val_separator</span><span class="p">,</span>
                <span class="s1">'outlier_std_max'</span><span class="p">:</span> <span class="n">outlier_std_max</span><span class="p">,</span>
                <span class="s1">'save_name'</span><span class="p">:</span> <span class="s1">'test_star_selection'</span><span class="p">,</span>
                <span class="s1">'save_extension'</span><span class="p">:</span> <span class="s1">'.fits'</span><span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mccd_extra_kw</span><span class="p">[</span><span class="s1">'val_model_input_dir'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span>
                <span class="s1">'VALIDATION'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'VAL_MODEL_INPUT_DIR'</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mccd_extra_kw</span><span class="p">[</span><span class="s1">'val_model_input_dir'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span>
                <span class="s1">'VALIDATION'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'VAL_OUTPUT_DIR'</span><span class="p">)</span>

<div class="viewcode-block" id="MCCDParamsParser.get_extra_kw"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.MCCDParamsParser.get_extra_kw">[docs]</a>    <span class="k">def</span> <span class="nf">get_extra_kw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_name</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Get parameter from extra arguments.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        param_name: str</span>
<span class="sd">            Name of the parameter</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inputs_kw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_inputs_kw</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_val_prepro_kw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_val_kw</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_extra_kw</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span></div>

<div class="viewcode-block" id="MCCDParamsParser.get_fit_kw"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.MCCDParamsParser.get_fit_kw">[docs]</a>    <span class="k">def</span> <span class="nf">get_fit_kw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Get fit parameter dictionary.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mccd_fit_kw: dict</span>
<span class="sd">            MCCD fit parameter dictionary.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_fit_kw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_fit_kw</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_fit_kw</span></div>

<div class="viewcode-block" id="MCCDParamsParser.get_instance_kw"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.MCCDParamsParser.get_instance_kw">[docs]</a>    <span class="k">def</span> <span class="nf">get_instance_kw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Get instace parameter dictionary.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mccd_inst_kw: dict</span>
<span class="sd">            MCCD instance parameter dictionary.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inst_kw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_instance_kw</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inst_kw</span></div>

<div class="viewcode-block" id="MCCDParamsParser.get_inputs_kw"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.MCCDParamsParser.get_inputs_kw">[docs]</a>    <span class="k">def</span> <span class="nf">get_inputs_kw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Get paths parameter dictionary.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mccd_inputs_kw: dict</span>
<span class="sd">             MCCD input parameter dictionary.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inputs_kw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_inputs_kw</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inputs_kw</span></div>

<div class="viewcode-block" id="MCCDParamsParser.get_val_prepro_kw"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.MCCDParamsParser.get_val_prepro_kw">[docs]</a>    <span class="k">def</span> <span class="nf">get_val_prepro_kw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Get preprocessing validation input dictionary.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mccd_val_prepro_kw: dict</span>
<span class="sd">             MCCD preprocessing validation input dictionary.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_val_prepro_kw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_val_kw</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_val_prepro_kw</span></div>

<div class="viewcode-block" id="MCCDParamsParser.get_val_kw"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.MCCDParamsParser.get_val_kw">[docs]</a>    <span class="k">def</span> <span class="nf">get_val_kw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Get validaiton parameter dictionary.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mccd_val_kw: dict</span>
<span class="sd">             MCCD validation dictionary.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_val_kw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_val_kw</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_val_kw</span></div></div>


<div class="viewcode-block" id="RunMCCD"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.RunMCCD">[docs]</a><span class="k">class</span> <span class="nc">RunMCCD</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">"""Run the MCCD method.</span>

<span class="sd">    This class allows to run the MCCD method using the paramters present on</span>
<span class="sd">    the configuration file. Saves the fitted model on the output directory</span>
<span class="sd">    found in the MCCD configuration file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config_file_path: str</span>
<span class="sd">        Path to the configuration file.</span>
<span class="sd">    fits_table_pos: int</span>
<span class="sd">        Position of the Table in the fits file.</span>
<span class="sd">        Default is ``1``.</span>
<span class="sd">    verbose: bool</span>
<span class="sd">        Verbose mode.</span>
<span class="sd">        Default is ``True``.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Missing:</span>
<span class="sd">    - Method including the validation.</span>
<span class="sd">    - Erase the preprocessed files (?)</span>

<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file_path</span><span class="p">,</span> <span class="n">fits_table_pos</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Initialize class."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_file_path</span> <span class="o">=</span> <span class="n">config_file_path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">param_parser</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inputs_kw</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inst_kw</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mccd_fit_kw</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mccd_val_prepro_kw</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mccd_val_kw</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">val_mccd_inputs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inputs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_catalog_ids</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog_ids</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_name</span> <span class="o">=</span> <span class="s1">'train_star_selection'</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_extension</span> <span class="o">=</span> <span class="s1">'.fits'</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_table_pos</span> <span class="o">=</span> <span class="n">fits_table_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fitting_model_saving_name</span> <span class="o">=</span> <span class="s1">'fitted_model'</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">val_saving_name</span> <span class="o">=</span> <span class="s1">'validation_psf'</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_SNR_weight</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_output_dir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parsed_parameters</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

<div class="viewcode-block" id="RunMCCD.parse_config_file"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.RunMCCD.parse_config_file">[docs]</a>    <span class="k">def</span> <span class="nf">parse_config_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Parse configuration file and recover parameters."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param_parser</span> <span class="o">=</span> <span class="n">MCCDParamsParser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_file_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inputs_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_parser</span><span class="o">.</span><span class="n">get_inputs_kw</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inst_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_parser</span><span class="o">.</span><span class="n">get_instance_kw</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mccd_fit_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_parser</span><span class="o">.</span><span class="n">get_fit_kw</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mccd_val_prepro_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_parser</span><span class="o">.</span><span class="n">get_val_prepro_kw</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mccd_val_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_parser</span><span class="o">.</span><span class="n">get_val_kw</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inputs_kw</span><span class="p">[</span><span class="s1">'separator'</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_SNR_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_parser</span><span class="o">.</span><span class="n">get_extra_kw</span><span class="p">(</span>
                <span class="s1">'use_SNR_weight'</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_parser</span><span class="o">.</span><span class="n">get_extra_kw</span><span class="p">(</span><span class="s1">'output_dir'</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">parsed_parameters</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="RunMCCD.preprocess_inputs"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.RunMCCD.preprocess_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">preprocess_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Preprocess the input data."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_config_file</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inputs</span> <span class="o">=</span> <span class="n">mccd_preprocessing</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mccd_inputs_kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inputs</span><span class="o">.</span><span class="n">get_catalog_ids</span><span class="p">()</span></div>

<div class="viewcode-block" id="RunMCCD.preprocess_val_inputs"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.RunMCCD.preprocess_val_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">preprocess_val_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Preprocess validation input data."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_config_file</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_mccd_inputs</span> <span class="o">=</span> <span class="n">mccd_preprocessing</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mccd_val_prepro_kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_catalog_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_mccd_inputs</span><span class="o">.</span><span class="n">get_catalog_ids</span><span class="p">()</span></div>

<div class="viewcode-block" id="RunMCCD.fit_models"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.RunMCCD.fit_models">[docs]</a>    <span class="k">def</span> <span class="nf">fit_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Build and save the models to the catalgos found."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_config_file</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_inputs</span><span class="p">()</span>

        <span class="n">input_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inputs_kw</span><span class="p">[</span><span class="s1">'output_path'</span><span class="p">]</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_output_dir</span>

        <span class="k">for</span> <span class="n">_cat_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_cat_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">cat_id</span> <span class="o">=</span> <span class="s1">'</span><span class="si">%07d</span><span class="s1">'</span> <span class="o">%</span> <span class="n">_cat_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cat_id</span> <span class="o">=</span> <span class="n">_cat_id</span>

            <span class="n">input_path</span> <span class="o">=</span> <span class="n">input_dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_name</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> \
                <span class="o">+</span> <span class="n">cat_id</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_extension</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">input_path</span><span class="p">):</span>
                <span class="n">starcat</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_table_pos</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">'File </span><span class="si">{}</span><span class="s1"> not found.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">input_path</span><span class="p">))</span>

            <span class="n">mccd_fit</span><span class="p">(</span><span class="n">starcat</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">mccd_inst_kw</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">mccd_fit_kw</span><span class="p">,</span>
                     <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
                     <span class="n">catalog_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">cat_id</span><span class="p">),</span>
                     <span class="n">sex_thresh</span><span class="o">=-</span><span class="mf">1e5</span><span class="p">,</span>
                     <span class="n">use_SNR_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_SNR_weight</span><span class="p">,</span>
                     <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                     <span class="n">saving_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fitting_model_saving_name</span> <span class="o">+</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span></div>

<div class="viewcode-block" id="RunMCCD.validate_models"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.RunMCCD.validate_models">[docs]</a>    <span class="k">def</span> <span class="nf">validate_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Validate MCCD models."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_config_file</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_mccd_inputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_val_inputs</span><span class="p">()</span>

        <span class="c1"># Preprocessed validation dir</span>
        <span class="n">input_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_val_prepro_kw</span><span class="p">[</span><span class="s1">'output_path'</span><span class="p">]</span>
        <span class="c1"># Fit model input dir</span>
        <span class="n">fit_model_input_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_parser</span><span class="o">.</span><span class="n">get_extra_kw</span><span class="p">(</span>
            <span class="s1">'val_model_input_dir'</span><span class="p">)</span>
        <span class="c1"># Validation output dir</span>
        <span class="n">val_output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_parser</span><span class="o">.</span><span class="n">get_extra_kw</span><span class="p">(</span><span class="s1">'val_model_input_dir'</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_cat_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_catalog_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_cat_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">cat_id</span> <span class="o">=</span> <span class="s1">'</span><span class="si">%07d</span><span class="s1">'</span> <span class="o">%</span> <span class="n">_cat_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cat_id</span> <span class="o">=</span> <span class="n">_cat_id</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">'Validating catalog </span><span class="si">%s</span><span class="s1">..'</span> <span class="o">%</span> <span class="n">cat_id</span><span class="p">)</span>

            <span class="c1"># Check if there is the fitted model</span>
            <span class="n">fit_model_path</span> <span class="o">=</span> <span class="n">fit_model_input_dir</span> <span class="o">+</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">fitting_model_saving_name</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">+</span> \
                <span class="n">cat_id</span> <span class="o">+</span> <span class="s1">'.npy'</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fit_model_path</span><span class="p">):</span>
                <span class="n">prepro_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_val_prepro_kw</span><span class="p">[</span><span class="s1">'save_name'</span><span class="p">]</span>
                <span class="n">separator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_val_prepro_kw</span><span class="p">[</span><span class="s1">'separator'</span><span class="p">]</span>
                <span class="n">save_extension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mccd_val_prepro_kw</span><span class="p">[</span><span class="s1">'save_extension'</span><span class="p">]</span>
                <span class="n">input_val_path</span> <span class="o">=</span> <span class="n">input_dir</span> <span class="o">+</span> <span class="n">prepro_name</span> <span class="o">+</span> <span class="n">separator</span> <span class="o">+</span> \
                    <span class="n">cat_id</span> <span class="o">+</span> <span class="n">save_extension</span>

                <span class="n">testcat</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_val_path</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">fits_table_pos</span><span class="p">]</span>

                <span class="n">val_dict</span> <span class="o">=</span> <span class="n">mccd_validation</span><span class="p">(</span><span class="n">fit_model_path</span><span class="p">,</span>
                                           <span class="n">testcat</span><span class="p">,</span>
                                           <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mccd_val_kw</span><span class="p">,</span>
                                           <span class="n">sex_thresh</span><span class="o">=-</span><span class="mf">1e5</span><span class="p">)</span>

                <span class="n">saving_path</span> <span class="o">=</span> <span class="n">val_output_dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_saving_name</span> <span class="o">+</span> \
                    <span class="n">separator</span> <span class="o">+</span> <span class="n">cat_id</span> <span class="o">+</span> <span class="n">save_extension</span>
                <span class="c1"># Save validation dictionary to fits file</span>
                <span class="n">mccd_utils</span><span class="o">.</span><span class="n">save_to_fits</span><span class="p">(</span><span class="n">val_dict</span><span class="p">,</span> <span class="n">saving_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">'Validation catalog &lt; </span><span class="si">%s</span><span class="s1"> &gt; saved.'</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">val_saving_name</span> <span class="o">+</span> <span class="n">separator</span> <span class="o">+</span> <span class="n">cat_id</span> <span class="o">+</span>
                            <span class="n">save_extension</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">'''Fitted model corresponding to catalog </span><span class="si">%d</span><span class="s1"> was not</span>
<span class="s1">                    found.'''</span> <span class="o">%</span> <span class="n">cat_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="RunMCCD.fit_MCCD_models"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.RunMCCD.fit_MCCD_models">[docs]</a>    <span class="k">def</span> <span class="nf">fit_MCCD_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Fit MCCD models."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_config_file</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_inputs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_models</span><span class="p">()</span></div>

<div class="viewcode-block" id="RunMCCD.validate_MCCD_models"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.RunMCCD.validate_MCCD_models">[docs]</a>    <span class="k">def</span> <span class="nf">validate_MCCD_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Validate MCCD models."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_config_file</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_val_inputs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_models</span><span class="p">()</span></div>

<div class="viewcode-block" id="RunMCCD.run_MCCD"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.RunMCCD.run_MCCD">[docs]</a>    <span class="k">def</span> <span class="nf">run_MCCD</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Run the MCCD routines."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_config_file</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_inputs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_models</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_val_inputs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_models</span><span class="p">()</span></div>

<div class="viewcode-block" id="RunMCCD.recover_MCCD_PSFs"><a class="viewcode-back" href="../../mccd.auxiliary_fun.html#mccd.auxiliary_fun.RunMCCD.recover_MCCD_PSFs">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">recover_MCCD_PSFs</span><span class="p">(</span><span class="n">mccd_model_path</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">ccd_id</span><span class="p">,</span> <span class="n">local_pos</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Recover MCCD PSFs at required positions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mccd_model_path: str</span>
<span class="sd">            Path pointing to the saved fitted MCCD model to be used.</span>
<span class="sd">        positions: numpy.ndarray</span>
<span class="sd">            Array containing the positions where the PSF should be recovered.</span>
<span class="sd">            The shape of the array should be (n,2) [x,y].</span>
<span class="sd">        ccd_id: int</span>
<span class="sd">            Id of the CCD from where the positions where taken.</span>
<span class="sd">        local_pos: bool</span>
<span class="sd">            If the positions passed are local to the CCD. If False, the</span>
<span class="sd">            positions are considered to be in the same format</span>
<span class="sd">            (coordinate system, units, etc.) as the ``obs_pos`` fed</span>
<span class="sd">            to :func:`MCCD.fit`.</span>
<span class="sd">            Default is ``False``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rec_PSFs: numpy.ndarray</span>
<span class="sd">            Array containing the recovered PSFs.</span>
<span class="sd">            Array dimensions: (n_psf, n_im, n_im).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        OSError</span>
<span class="sd">            For non-existent fitted model.</span>
<span class="sd">        ValueError</span>
<span class="sd">            For ccd_id not being an integer.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">mccd_model_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">'Fitted model </span><span class="si">{}</span><span class="s1"> not found.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mccd_model_path</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ccd_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'Parameter ccd_id should be an integer.'</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">local_pos</span><span class="p">:</span>
            <span class="n">loc2glob</span> <span class="o">=</span> <span class="n">mccd_utils</span><span class="o">.</span><span class="n">Loc2Glob</span><span class="p">()</span>
            <span class="n">glob_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="n">loc2glob</span><span class="o">.</span><span class="n">loc2glob_img_coord</span><span class="p">(</span><span class="n">ccd_id</span><span class="p">,</span> <span class="n">_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">_pos</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">glob_pos</span> <span class="o">=</span> <span class="n">positions</span>

        <span class="c1"># Import the model</span>
        <span class="n">mccd_model</span> <span class="o">=</span> <span class="n">mccd</span><span class="o">.</span><span class="n">mccd_quickload</span><span class="p">(</span><span class="n">mccd_model_path</span><span class="p">)</span>

        <span class="n">rec_PSFs</span> <span class="o">=</span> <span class="n">mccd_model</span><span class="o">.</span><span class="n">estimate_psf</span><span class="p">(</span><span class="n">glob_pos</span><span class="p">,</span> <span class="n">ccd_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rec_PSFs</span></div></div>
</code></pre>
</main>
<footer class="mt-20 px-5 md:ml-fluid mb-4 flex-shrink-0 text-sm text-gray-700" role="contentinfo">© Copyright configure_year, Tobias Liaudat Last updated: 19 Jul, 2021. Made with <a href="https://www.sphinx-doc.org">Sphinx 3.3.1</a></footer>
</div>
<div class="sticky bottom-0 md:hidden print:hidden bg-white">
<div class="flex justify-center items-center">
<button aria-labelledby="menuLabel" class="text-3xl p-4 flex items-center focus:bg-gray-200" id="openNavBtn">
<svg aria-hidden="true" class="fill-current h-8 w-8" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg>
<span class="pl-2 text-sm font-medium uppercase tracking-wide text-gray-700" id="menuLabel">Menu</span>
</button><button aria-labelledby="searchLabel" class="text-3xl p-4 flex items-center focus:bg-gray-200" id="openSearchBtn">
<svg aria-hidden="true" class="fill-current h-8 w-8" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg>
<span class="pl-2 text-sm font-medium uppercase tracking-wide text-gray-700" id="searchLabel">Search</span>
</button>
</div>
</div>
<div class="w-full fixed bottom-0 left-0 z-10 bg-gray-900 overflow-x-hidden pt-10 flex flex-col items-center md:hidden" data-menu="closed" id="search-pane">
<h4 class="text-xl text-white mb-4" id="search-label">Enter search term</h4><form action="../../search.html" class="flex w-full justify-between items-center max-w-sm px-12" id="searchbox" method="get">
<input aria-labelledby="search-label" class="p-2 flex-1" name="q" placeholder="Search the docs" type="search"/>
<button aria-label="Get search results" class="p-2 text-white bg-gray-700 hover:bg-gray-200 hover:text-pink-500 focus:bg-gray-200 focus:text-pink-500 tooltipped tooltipped-sw">
<svg aria-hidden="true" class="fill-current stroke-current h-6 w-6" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg>
</button>
</form>
<button aria-label="Close menu" class="text-4xl text-gray-200 p-4 bottom-0 hover:text-pink-500 md:hidden focus:text-pink-500 self-center" id="closeSearchBtn" title="Close menu">
<svg aria-hidden="true" class="fill-current stroke-current h-6 w-6" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</div>
<div class="fixed bottom-0 right-0 opacity-0 p-4 m-4 rounded bg-gray-900 text-gray-100 transition transform duration-500 translate-y-full" id="snackbar"></div>
<div class="fixed inset-0 bg-black bg-opacity-50" id="screen" style="display: none;"></div>
</div>
<script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js">
</script>
<script src="../../_static/jquery.js"></script>
<script src="../../_static/underscore.js"></script>
<script src="../../_static/doctools.js"></script>
<script src="../../_static/language_data.js"></script>
<script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
<script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
<script defer="" src="../../_static/theme.js"></script>
</body>
</html>